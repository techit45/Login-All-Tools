<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบสำคัญจ่าย - Payment Slip Processing System</title>
    <style>
        /* ==================== CSS Styles ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #1e3c72 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
            margin-top: 30px;
        }

        .content-area {
            min-width: 0; /* ป้องกัน grid overflow */
        }

        .right-sidebar {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            padding: 0;
            overflow: hidden;
            position: sticky;
            top: 20px;
            height: fit-content;
            max-height: calc(100vh - 40px);
        }

        /* Header Styles */
        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .logo-container {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .logo-container img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
        }

        .logo-placeholder {
            font-size: 32px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: bold;
        }

        .header h1 {
            background: linear-gradient(45deg, #ffffff, #e3f2fd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.8em;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            font-weight: 700;
        }

        .company-tagline {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1em;
            margin-top: 5px;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .header p {
            color: rgba(255,255,255,0.9);
            font-size: 1.2em;
        }

        /* Tab System */
        .tab-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .tab-nav {
            display: flex;
            border-bottom: 2px solid #f0f0f0;
        }

        .tab-btn {
            flex: 1;
            padding: 20px;
            border: none;
            background: white;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-btn:hover {
            background: #f8f9ff;
        }

        .tab-btn.active {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Form Styles */
        .form-section {
            margin-bottom: 30px;
        }

        .section-title {
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.5em;
            margin-bottom: 20px;
            font-weight: 600;
        }

        /* Entry Items */
        .entries-container {
            margin-bottom: 30px;
        }

        .entry-item {
            background: #f8f9ff;
            border: 2px solid #e6e8ff;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            position: relative;
        }

        .entry-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e6e8ff;
        }

        .entry-header h4 {
            color: #667eea;
            font-size: 1.3em;
            font-weight: 600;
        }

        .btn-remove-entry {
            background: linear-gradient(45deg, #ff6b6b, #ee5a52);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .btn-remove-entry:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,107,107,0.4);
        }

        /* Form Groups */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 1.1em;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        .form-group textarea {
            height: 100px;
            resize: vertical;
        }
        
        .form-group textarea[readonly] {
            background-color: #f8f9fa;
            color: #6c757d;
        }
        
        /* Date Range Styling */
        .date-range-container {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 5px;
        }
        
        .date-range-container input[type="number"],
        .date-range-container select {
            padding: 8px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        
        .date-range-container input[type="number"]:focus,
        .date-range-container select:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 2px rgba(42,82,152,0.1);
        }
        
        .date-range-separator {
            font-weight: bold;
            color: #2a5298;
            font-size: 1.1em;
        }

        /* File Upload */
        .file-upload {
            position: relative;
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
            background: white;
        }

        .file-upload:hover {
            border-color: #2a5298;
            background: #f0f7ff;
        }

        .file-upload.dragover {
            border-color: #2a5298;
            background: #e3f2fd;
            transform: scale(1.02);
        }

        .file-upload input[type="file"] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .file-upload-content {
            pointer-events: none;
        }

        .file-upload-icon {
            font-size: 3em;
            margin-bottom: 10px;
            color: #ccc;
        }

        .file-upload.dragover .file-upload-icon {
            color: #667eea;
        }

        .file-selected {
            background: #e8f5e8;
            border-color: #4caf50;
            color: #2e7d32;
        }

        .file-info {
            margin-top: 10px;
            padding: 10px;
            background: rgba(76,175,80,0.1);
            border-radius: 5px;
            font-size: 0.9em;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .file-item {
            margin: 5px 0;
            padding: 8px;
            background: #f0f0f0;
            border-radius: 5px;
            border-left: 3px solid #4caf50;
        }
        
        .files-summary {
            margin-bottom: 10px;
            padding: 8px;
            background: rgba(76,175,80,0.2);
            border-radius: 5px;
            font-weight: bold;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(30,60,114,0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-add {
            background: linear-gradient(45deg, #0d47a1, #1565c0);
        }

        .btn-add:hover {
            box-shadow: 0 10px 20px rgba(13,71,161,0.3);
        }

        .btn-submit {
            background: linear-gradient(45deg, #0d47a1, #1565c0);
            font-size: 1.2em;
            padding: 15px 30px;
        }

        .btn-submit:hover {
            box-shadow: 0 10px 20px rgba(13,71,161,0.3);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        /* Name Management */
        .name-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .name-item {
            background: #f8f9ff;
            border: 2px solid #e6e8ff;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .name-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .name-item h4 {
            color: #667eea;
            margin-bottom: 5px;
        }

        .name-item p {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 3px;
        }

        .name-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.8em;
            border-radius: 5px;
        }

        .btn-edit {
            background: linear-gradient(45deg, #ff9800, #f57c00);
        }

        .btn-delete {
            background: linear-gradient(45deg, #f44336, #d32f2f);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-header h3 {
            color: #667eea;
            font-size: 1.4em;
        }

        .btn-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #999;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .btn-close:hover {
            background: #f0f0f0;
            color: #333;
        }

        /* Loading and Messages */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .result-message {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
            animation: slideInDown 0.5s ease;
        }

        .result-message.show {
            display: block;
        }

        .result-message.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result-message.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        @keyframes slideInDown {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            background: #f0f0f0;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }

        .progress-container.show {
            display: block;
        }

        .progress-bar {
            height: 8px;
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            border-radius: 10px;
            transition: width 0.3s ease;
            width: 0%;
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .file-preview-item {
                width: 250px;
                height: 250px;
            }
            
            .file-preview-pdf-icon {
                font-size: 60px;
            }
            
            .file-preview-pdf {
                font-size: 20px;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .tab-content {
                padding: 20px;
            }

            .entry-item {
                padding: 20px;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .name-list {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
            }

            .entry-header {
                flex-direction: column;
                gap: 10px;
                align-items: flex-start;
            }

            .btn-remove-entry {
                align-self: flex-end;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.6em;
            }

            .header p {
                font-size: 1em;
            }

            .tab-btn {
                padding: 15px 10px;
                font-size: 1em;
            }

            .tab-content {
                padding: 15px;
            }

            .entry-item {
                padding: 15px;
            }
            
            /* ปรับขนาด preview บนมือถือ */
            .file-preview-item {
                width: 200px;
                height: 200px;
            }
            
            .file-preview-pdf-icon {
                font-size: 48px;
            }
            
            .file-preview-pdf {
                font-size: 16px;
            }
            
            .file-preview-overlay {
                font-size: 14px;
                padding: 12px 8px 8px;
            }
        }

        /* Image Preview Styles */
        .file-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px dashed #dee2e6;
        }

        .file-preview-item {
            position: relative;
            width: 300px;
            height: 300px;
            border: 4px solid #e9ecef;
            border-radius: 20px;
            overflow: hidden;
            background: white;
            box-shadow: 0 6px 24px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-preview-item:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 48px rgba(0,0,0,0.25);
            border-color: #2a5298;
        }

        .file-preview-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .file-preview-item:hover .file-preview-image {
            transform: scale(1.05);
        }

        .file-preview-pdf {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            text-align: center;
            font-size: 24px;
            font-weight: 600;
        }

        .file-preview-pdf-icon {
            font-size: 72px;
            margin-bottom: 15px;
        }

        .file-preview-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.8));
            color: white;
            padding: 16px 12px 12px;
            font-size: 16px;
            font-weight: 500;
            text-align: center;
            word-break: break-word;
            line-height: 1.3;
        }

        /* Image Modal/Lightbox */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease;
        }

        .image-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-modal-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            margin: auto;
            animation: zoomIn 0.3s ease;
        }

        .image-modal-image {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .image-modal-pdf {
            width: 90vw;
            height: 90vh;
            border-radius: 10px;
            border: none;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .image-modal-close {
            position: absolute;
            top: -40px;
            right: -40px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-modal-close:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .image-modal-info {
            position: absolute;
            bottom: -50px;
            left: 0;
            right: 0;
            color: white;
            text-align: center;
            font-size: 14px;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 5px;
        }

        @keyframes zoomIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* File Info Enhancements */
        .file-info {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
        }

        .file-info .files-summary {
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #dee2e6;
        }

        .file-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 8px 12px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .file-item:hover {
            border-color: #2a5298;
            box-shadow: 0 2px 4px rgba(42,82,152,0.1);
        }

        /* Sidebar Styles */
        .sidebar-header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .sidebar-header h3 {
            margin: 0 0 5px 0;
            font-size: 1.1em;
            font-weight: 600;
        }

        .sidebar-header p {
            margin: 0;
            font-size: 0.9em;
            opacity: 0.9;
        }

        .sidebar-content {
            padding: 20px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .submitted-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex-grow: 1;
            margin-bottom: 15px;
        }

        .submitted-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #28a745;
            transition: all 0.3s ease;
        }

        .submitted-item:hover {
            background: #e9ecef;
            transform: translateX(2px);
        }

        .submitted-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9em;
            flex-shrink: 0;
        }

        .submitted-info {
            flex: 1;
            min-width: 0;
        }

        .submitted-info h5 {
            margin: 0 0 4px 0;
            font-size: 0.9em;
            font-weight: 600;
            color: #1e3c72;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .submitted-info p {
            margin: 0;
            font-size: 0.75em;
            color: #6c757d;
        }

        .submitted-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            flex-shrink: 0;
        }

        .sidebar-stats {
            background: linear-gradient(135deg, #e3f2fd, #f0f7ff);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .sidebar-controls {
            margin-bottom: 20px;
            text-align: center;
        }

        .btn-reset {
            background: linear-gradient(45deg, #dc3545, #c82333) !important;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-reset:hover {
            background: linear-gradient(45deg, #c82333, #bd2130) !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
        }

        .stats-number {
            font-size: 2em;
            font-weight: 800;
            color: #1e3c72;
            margin-bottom: 5px;
        }

        .stats-label {
            font-size: 0.9em;
            color: #6c757d;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }

        .empty-state .icon {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .empty-state h4 {
            margin: 0 0 8px 0;
            font-size: 1em;
            color: #495057;
        }

        .empty-state p {
            margin: 0;
            font-size: 0.8em;
        }

        /* Google Drive Link Styles */
        .drive-link-section {
            margin-top: auto;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }

        .drive-link-header {
            margin-bottom: 12px;
        }

        .drive-link-header h4 {
            margin: 0;
            font-size: 0.9em;
            color: #1e3c72;
            font-weight: 600;
        }

        .drive-link-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: linear-gradient(135deg, #f8f9fa, #ffffff);
            border: 1px solid #e9ecef;
            border-radius: 10px;
            text-decoration: none;
            color: inherit;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .drive-link-btn:hover {
            background: linear-gradient(135deg, #e3f2fd, #f0f7ff);
            border-color: #2a5298;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(42, 82, 152, 0.15);
            text-decoration: none;
            color: inherit;
        }

        .drive-icon {
            font-size: 1.5em;
            flex-shrink: 0;
        }

        .drive-text {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .drive-title {
            font-weight: 600;
            font-size: 0.9em;
            color: #1e3c72;
        }

        .drive-subtitle {
            font-size: 0.75em;
            color: #6c757d;
        }

        .drive-arrow {
            font-size: 1.2em;
            color: #2a5298;
            font-weight: bold;
            transition: transform 0.3s ease;
        }

        .drive-link-btn:hover .drive-arrow {
            transform: translateX(3px);
        }

        /* Clickable submitted items */
        .submitted-item.clickable {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submitted-item.clickable:hover {
            background: #e3f2fd;
            transform: translateX(3px);
            border-left-color: #1e3c72;
        }

        /* Detail Modal Styles */
        .detail-modal-content {
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .detail-modal-body {
            padding: 0;
        }

        .submission-detail-header {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            padding: 20px;
            margin: -30px -30px 20px -30px;
            border-radius: 15px 15px 0 0;
        }

        .submission-detail-header h3 {
            margin: 0 0 8px 0;
            font-size: 1.3em;
        }

        .submission-detail-header h4 {
            margin: 0;
            font-size: 1.1em;
            opacity: 0.9;
        }

        .submission-basic-info,
        .submission-ocr-info,
        .submission-entries-info {
            margin-bottom: 25px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #2a5298;
        }

        .submission-ocr-info {
            border-left-color: #28a745;
        }

        .submission-entries-info {
            border-left-color: #ffc107;
        }

        .submission-basic-info h5,
        .submission-ocr-info h5,
        .submission-entries-info h5 {
            margin: 0 0 15px 0;
            color: #1e3c72;
            font-size: 1.1em;
            font-weight: 600;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .detail-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .detail-item strong {
            color: #495057;
            font-weight: 600;
            min-width: 140px;
            flex-shrink: 0;
        }

        .detail-item span {
            text-align: right;
            color: #1e3c72;
            font-weight: 500;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        .entry-detail {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
        }

        .entry-detail h6 {
            margin: 0 0 12px 0;
            color: #1e3c72;
            font-size: 1em;
            font-weight: 600;
            padding-bottom: 8px;
            border-bottom: 2px solid #e3f2fd;
        }

        .payment-types-list {
            text-align: right;
        }

        .payment-type-item {
            margin-bottom: 8px;
            padding: 6px 12px;
            background: #e3f2fd;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .payment-type-item:last-child {
            margin-bottom: 0;
        }

        .payment-type-item small {
            color: #6c757d;
            font-style: italic;
        }

        /* OCR Multiple Files Styles */
        .ocr-file-result {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            border: 1px solid #e9ecef;
            border-left: 4px solid #28a745;
        }

        .ocr-file-result h6 {
            margin: 0 0 12px 0;
            color: #28a745;
            font-size: 0.95em;
            font-weight: 600;
            padding-bottom: 8px;
            border-bottom: 1px solid #e9ecef;
        }

        .ocr-file-result:last-child {
            margin-bottom: 0;
        }

        /* Responsive Detail Modal */
        @media (max-width: 768px) {
            .detail-modal-content {
                max-width: 95%;
                margin: 20px auto;
            }

            .detail-item {
                flex-direction: column;
                gap: 4px;
            }

            .detail-item strong {
                min-width: auto;
            }

            .detail-item span {
                text-align: left;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Responsive Sidebar */
        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr 250px;
                gap: 20px;
            }
        }

        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .right-sidebar {
                position: relative;
                top: 0;
                max-height: none;
                order: -1;
            }
        }

        /* OCR Result Styles */
        .ocr-container {
            margin: 15px 0;
        }

        .ocr-result {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #28a745;
            animation: slideInDown 0.5s ease;
        }

        .ocr-result.success {
            border-left-color: #28a745;
            background: linear-gradient(135deg, #e8f5e8, #f0fff0);
        }

        .ocr-result.error {
            border-left-color: #dc3545;
            background: linear-gradient(135deg, #ffeaea, #fff0f0);
        }

        .ocr-result h4 {
            color: #1e3c72;
            margin: 0 0 10px 0;
            font-size: 1.1em;
            font-weight: 600;
        }

        .ocr-result .recipient-info h4 {
            color: #28a745;
            font-size: 1.2em;
            margin: 8px 0;
            font-weight: 700;
        }

        .ocr-result p {
            margin: 5px 0;
            color: #6c757d;
            font-size: 0.9em;
        }

        .ocr-result small {
            color: #6c757d;
            font-size: 0.8em;
        }

        .ocr-result.error h4 {
            color: #dc3545;
        }

        /* Additional Utility Classes */
        .text-center { text-align: center; }
        .mt-20 { margin-top: 20px; }
        .mb-20 { margin-bottom: 20px; }
        .hidden { display: none !important; }
        .visible { display: block !important; }
    </style>
</head>
<body>
    <!-- Header Section -->
    <div class="container">
        <div class="header">
            <div class="header-logo">
                <div class="logo-container">
                    <!-- Logo image slot - คุณสามารถแก้ไข src ได้ -->
                    <img src="Logo.png" alt="Login Learning Logo" style="display: none;" id="companyLogo">
                    <div class="logo-placeholder" id="logoPlaceholder">LL</div>
                </div>
                <div>
                    <h1>Login Learning</h1>
                    <div class="company-tagline">Payment Management System</div>
                </div>
            </div>
            <p>ระบบจัดการสลิปการจ่ายเงิน</p>
        </div>

        <div class="main-layout">
            <!-- Main Content Area -->
            <div class="content-area">
                <!-- Main Tab Container -->
                <div class="tab-container">
            <!-- Tab Navigation -->
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchTab('upload-tab', this)">
                    📄 อัปโหลดสลิป
                </button>
                <button class="tab-btn" onclick="switchTab('names-tab', this)">
                    👥 จัดการรายชื่อ
                </button>
            </div>

            <!-- Tab 1: Upload Slips -->
            <div id="upload-tab" class="tab-content active">
                <div class="form-section">
                    <h2 class="section-title">📋 ระบบอัปโหลดสลิปการจ่ายเงิน</h2>
                    
                    <!-- ประเภทผู้ใช้งาน -->
                    <div class="form-group">
                        <label for="userType">👤 ประเภทผู้ใช้งาน *</label>
                        <select id="userType" required>
                            <option value="">-- เลือกประเภทผู้ใช้งาน --</option>
                            <option value="board_member">🏛️ กรรมการบริษัท</option>
                            <option value="employee" selected>👥 พนักงานทั่วไป</option>
                        </select>
                    </div>
                    
                    <form id="paymentForm">
                        <div id="entriesContainer" class="entries-container">
                            <!-- รายการจะถูกเพิ่มที่นี่ผ่าน JavaScript -->
                        </div>

                        <div class="button-group">
                            <button type="button" class="btn btn-add" onclick="addEntry()">
                                📂 เพิ่มรายการใหม่
                            </button>
                            <button type="submit" class="btn btn-submit">
                                🚀 ส่งข้อมูลทั้งหมด
                            </button>
                        </div>
                    </form>

                    <!-- Loading และ Progress -->
                    <div id="loadingSection" class="loading">
                        <div class="spinner"></div>
                        <p>กำลังประมวลผลข้อมูล...</p>
                        <div id="progressContainer" class="progress-container">
                            <div id="progressBar" class="progress-bar"></div>
                        </div>
                    </div>

                    <!-- Result Messages -->
                    <div id="resultMessage" class="result-message"></div>
                </div>
            </div>

            <!-- Tab 2: Name Management -->
            <div id="names-tab" class="tab-content">
                <div class="form-section">
                    <h2 class="section-title">👥 จัดการรายชื่อพนักงาน</h2>
                    
                    <div class="button-group mb-20">
                        <button class="btn btn-add" onclick="openAddModal()">
                            ➕ เพิ่มรายชื่อใหม่
                        </button>
                    </div>

                    <div id="namesList" class="name-list">
                        <!-- รายชื่อจะถูกแสดงที่นี่ผ่าน JavaScript -->
                    </div>
                </div>
            </div>
        </div>
            </div>
            
            <!-- Right Sidebar -->
            <div class="right-sidebar">
                <div class="sidebar-header">
                    <h3>📊 สถานะการส่งสลิป</h3>
                    <p>รายชื่อผู้ส่งแล้ว</p>
                </div>
                <div class="sidebar-content">
                    <div class="sidebar-stats">
                        <div class="stats-number" id="submittedCount">0</div>
                        <div class="stats-label">คนส่งแล้ว</div>
                    </div>
                    
                    <!-- Reset Button -->
                    <div class="sidebar-controls">
                        <button class="btn btn-reset" onclick="resetSubmittedUsers()">
                            🗑️ ล้างข้อมูลทั้งหมด
                        </button>
                    </div>
                    
                    <div class="submitted-list" id="submittedList">
                        <div class="empty-state">
                            <div class="icon">📋</div>
                            <h4>ยังไม่มีการส่งสลิป</h4>
                            <p>เมื่อมีการส่งสลิปจะแสดงที่นี่</p>
                        </div>
                    </div>
                    
                    <!-- Google Drive Link Section -->
                    <div class="drive-link-section">
                        <div class="drive-link-header">
                            <h4>📁 เอกสารอ้างอิง</h4>
                        </div>
                        <a href="https://drive.google.com/drive/u/0/folders/1S6ty6ic0vh8JC0c1CR5XH3KSf8vni46w" 
                           target="_blank" 
                           class="drive-link-btn">
                            <div class="drive-icon">💾</div>
                            <div class="drive-text">
                                <span class="drive-title">Google Drive</span>
                                <span class="drive-subtitle">ไฟล์สำคัญจ่าย</span>
                            </div>
                            <div class="drive-arrow">→</div>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal สำหรับเพิ่ม/แก้ไขรายชื่อ -->
    <div id="nameModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">➕ เพิ่มรายชื่อใหม่</h3>
                <button class="btn-close" onclick="closeModal()">×</button>
            </div>
            
            <form id="nameForm">
                <div class="form-group">
                    <label for="nameInput">👤 ชื่อ-นามสกุล *</label>
                    <input type="text" id="nameInput" required placeholder="กรุณาใส่ชื่อ-นามสกุล">
                </div>
                
                <div class="form-group">
                    <label for="positionInput">💼 ตำแหน่ง</label>
                    <input type="text" id="positionInput" placeholder="ตำแหน่งงาน">
                </div>
                
                <div class="form-group">
                    <label for="departmentInput">🏢 แผนก</label>
                    <input type="text" id="departmentInput" placeholder="แผนกที่สังกัด">
                </div>
                
                <div class="form-group">
                    <label for="notesInput">📝 หมายเหตุ</label>
                    <textarea id="notesInput" placeholder="หมายเหตุเพิ่มเติม"></textarea>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn">💾 บันทึก</button>
                    <button type="button" class="btn" onclick="closeModal()" style="background: #6c757d;">❌ ยกเลิก</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Image Modal for Preview -->
    <div id="imageModal" class="image-modal">
        <div class="image-modal-content">
            <button class="image-modal-close" onclick="closeImageModal()">×</button>
            <img id="modalImage" class="image-modal-image" style="display: none;">
            <iframe id="modalPdf" class="image-modal-pdf" style="display: none;"></iframe>
            <div id="modalInfo" class="image-modal-info"></div>
        </div>
    </div>

    <!-- Detail Modal for Submission Details -->
    <div id="detailModal" class="modal">
        <div class="modal-content detail-modal-content">
            <div class="modal-header">
                <h3 id="detailModalTitle">รายละเอียดการส่งสลิป</h3>
                <button class="btn-close" onclick="closeDetailModal()">×</button>
            </div>
            <div id="detailModalBody" class="detail-modal-body">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <script>
        // ==================== JavaScript Functions ====================
        
        // ตัวแปรสำหรับเก็บข้อมูล
        let entryCount = 0;
        let editingIndex = -1;
        let submittedUsers = []; // เก็บรายชื่อคนที่ส่งสลิปแล้ว
        
        // รายชื่อพนักงานเริ่มต้น
        let nameList = [
            {name: "นายนพรัตน์ พิภักดี", position: "", department: "", notes: ""},
            {name: "นางสาวณัฐสุดา ทรงครุฑ", position: "", department: "", notes: ""},
            {name: "นายจิรายุ เทศอินทร์", position: "", department: "", notes: ""},
            {name: "นางสาวธีรธิดา ไชยชาติ", position: "", department: "", notes: ""},
            {name: "นายธนชาต ศรีนุรัตน์", position: "", department: "", notes: ""},
            {name: "นายสุวัฒน์ พลอยเพ็ชร", position: "", department: "", notes: ""},
            {name: "นางสาวชลิตา ประพัทธาคิณี", position: "", department: "", notes: ""},
            {name: "นางสาวกนกลักษณ์ สุขปลั่ง", position: "", department: "", notes: ""},
            {name: "นายธาม พงษ์เจี่ย", position: "", department: "", notes: ""},
            {name: "นายขัตติยะ ไกยะราช", position: "", department: "", notes: ""},
            {name: "นายเตชิษฐ์ ยอดเพ็ชร", position: "", department: "", notes: ""},
            {name: "นายณวัสน์ พรพัชรนิตย์", position: "", department: "", notes: ""},
            {name: "นายก้องภพ ขจรคติมา", position: "", department: "", notes: ""},
            {name: "นายธัชนนท์ ธงศรี", position: "", department: "", notes: ""},
            {name: "นายศักดื์สิทธิ์ โอ่คำ", position: "", department: "", notes: ""},
            {name: "นางสาวนพัสสภรณ์ นกแก้ว", position: "", department: "", notes: ""}
        ];

        // ==================== Logo Management ====================
        function initializeLogo() {
            const logoImg = document.getElementById('companyLogo');
            const logoPlaceholder = document.getElementById('logoPlaceholder');
            
            // ตรวจสอบว่ามี logo src หรือไม่
            logoImg.addEventListener('load', function() {
                if (this.src && this.src !== window.location.href) {
                    this.style.display = 'block';
                    logoPlaceholder.style.display = 'none';
                }
            });
            
            logoImg.addEventListener('error', function() {
                this.style.display = 'none';
                logoPlaceholder.style.display = 'block';
            });
        }

        // ==================== LocalStorage Management ====================
        function loadNameListFromStorage() {
            try {
                const storedNameList = localStorage.getItem('paymentSlipNameList');
                if (storedNameList) {
                    const parsedList = JSON.parse(storedNameList);
                    // รวมข้อมูลเก่ากับชื่อใหม่ที่มีข้อมูลตำแหน่งครบถ้วน
                    nameList.forEach((defaultItem, index) => {
                        const existingItem = parsedList.find(item => item.name === defaultItem.name);
                        if (existingItem) {
                            // อัปเดตข้อมูลจาก localStorage
                            nameList[index] = existingItem;
                        }
                    });
                    
                    // เพิ่มคนใหม่ที่อาจจะมีใน localStorage แต่ไม่มีในรายชื่อเริ่มต้น
                    parsedList.forEach(storedItem => {
                        if (!nameList.find(item => item.name === storedItem.name)) {
                            nameList.push(storedItem);
                        }
                    });
                }
            } catch (error) {
                console.warn('ไม่สามารถโหลดข้อมูลรายชื่อจาก LocalStorage:', error);
            }
        }
        
        function saveNameListToStorage() {
            try {
                localStorage.setItem('paymentSlipNameList', JSON.stringify(nameList));
                console.log('✅ บันทึกข้อมูลรายชื่อสำเร็จ');
            } catch (error) {
                console.error('❌ ไม่สามารถบันทึกข้อมูลรายชื่อได้:', error);
                showResult('ไม่สามารถบันทึกข้อมูลได้ กรุณาลองใหม่อีกครั้ง', 'error');
            }
        }

        // ==================== Sidebar Management ====================
        function updateSidebar() {
            const submittedCount = document.getElementById('submittedCount');
            const submittedList = document.getElementById('submittedList');
            
            // อัปเดตจำนวนคนส่งแล้ว
            submittedCount.textContent = submittedUsers.length;
            
            if (submittedUsers.length === 0) {
                // แสดง empty state
                submittedList.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">📋</div>
                        <h4>ยังไม่มีการส่งสลิป</h4>
                        <p>เมื่อมีการส่งสลิปจะแสดงที่นี่</p>
                    </div>
                `;
            } else {
                // แสดงรายชื่อคนที่ส่งแล้ว
                submittedList.innerHTML = submittedUsers.map((user, index) => {
                    const initials = user.name.split(' ')
                        .map(n => n.charAt(0))
                        .join('')
                        .substring(0, 2);
                    
                    const timeAgo = getTimeAgo(user.submittedAt);
                    
                    return `
                        <div class="submitted-item clickable" onclick="showSubmissionDetail(${index})">
                            <div class="submitted-avatar">${initials}</div>
                            <div class="submitted-info">
                                <h5>${user.name}</h5>
                                <p>ส่งเมื่อ ${timeAgo}</p>
                            </div>
                            <div class="submitted-status"></div>
                        </div>
                    `;
                }).join('');
            }
        }

        // ฟังก์ชันสำหรับแสดงรายละเอียดการส่งสลิป
        function showSubmissionDetail(userIndex) {
            const user = submittedUsers[userIndex];
            if (!user) return;

            // สร้าง HTML สำหรับแสดงรายละเอียด
            let detailsHTML = `
                <div class="submission-detail-header">
                    <h3>📋 รายละเอียดการส่งสลิป</h3>
                    <h4>👤 ${user.name}</h4>
                </div>
                
                <div class="submission-basic-info">
                    <div class="detail-item">
                        <strong>🎯 ชื่อผู้รับเงิน:</strong>
                        <span>${user.recipientName || 'ไม่ระบุ'}</span>
                    </div>
                    <div class="detail-item">
                        <strong>📅 วันที่ส่ง:</strong>
                        <span>${formatDateTime(user.submittedAt)}</span>
                    </div>
                    <div class="detail-item">
                        <strong>👥 ประเภทผู้ใช้:</strong>
                        <span>${user.userType === 'employee' ? 'พนักงานทั่วไป' : 'กรรมการบริษัท'}</span>
                    </div>
                </div>
            `;

            // แสดงข้อมูล OCR ถ้ามี
            if (user.submissionData && user.submissionData.ocrResult) {
                const ocr = user.submissionData.ocrResult;
                detailsHTML += `
                    <div class="submission-ocr-info">
                        <h5>🔍 ข้อมูลจาก OCR</h5>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <strong>💰 จำนวนเงิน:</strong>
                                <span>${ocr.amount || 'ไม่พบข้อมูล'}</span>
                            </div>
                            <div class="detail-item">
                                <strong>📅 วันที่โอน:</strong>
                                <span>${ocr.date || 'ไม่พบข้อมูล'}</span>
                            </div>
                            <div class="detail-item">
                                <strong>🏦 ธนาคาร:</strong>
                                <span>${ocr.bank || 'ไม่พบข้อมูล'}</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            // แสดงข้อมูล OCR จากหลายไฟล์ (สำหรับพนักงานทั่วไป)
            if (user.submissionData && user.submissionData.allOCRResults && user.submissionData.allOCRResults.length > 1) {
                detailsHTML += `
                    <div class="submission-ocr-info">
                        <h5>🔍 ข้อมูลจาก OCR (${user.submissionData.allOCRResults.length} ไฟล์)</h5>
                `;
                
                user.submissionData.allOCRResults.forEach((ocr, index) => {
                    detailsHTML += `
                        <div class="ocr-file-result">
                            <h6>📄 ไฟล์ที่ ${ocr.fileIndex}: ${ocr.filename}</h6>
                            <div class="detail-grid">
                                <div class="detail-item">
                                    <strong>👤 ผู้รับเงิน:</strong>
                                    <span>${ocr.recipientName || 'ไม่พบข้อมูล'}</span>
                                </div>
                                <div class="detail-item">
                                    <strong>💰 จำนวนเงิน:</strong>
                                    <span>${ocr.amount || 'ไม่พบข้อมูล'}</span>
                                </div>
                                <div class="detail-item">
                                    <strong>📅 วันที่โอน:</strong>
                                    <span>${ocr.date || 'ไม่พบข้อมูล'}</span>
                                </div>
                                <div class="detail-item">
                                    <strong>🏦 ธนาคาร:</strong>
                                    <span>${ocr.bank || 'ไม่พบข้อมูล'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                detailsHTML += `</div>`;
            }

            // แสดงรายละเอียดรายการทั้งหมด ถ้ามี
            if (user.submissionData && user.submissionData.entries) {
                detailsHTML += `
                    <div class="submission-entries-info">
                        <h5>📄 รายการที่ส่ง (${user.submissionData.entries.length} รายการ)</h5>
                `;

                user.submissionData.entries.forEach((entry, index) => {
                    detailsHTML += `
                        <div class="entry-detail">
                            <h6>รายการที่ ${entry.entryNumber || index + 1}</h6>
                            <div class="detail-item">
                                <strong>📝 รายละเอียด:</strong>
                                <span>${entry.details || 'ไม่ระบุ'}</span>
                            </div>
                            <div class="detail-item">
                                <strong>📎 จำนวนไฟล์:</strong>
                                <span>${entry.fileCount || 0} ไฟล์</span>
                            </div>
                        `;

                    // แสดงประเภทการจ่ายเงิน (สำหรับกรรมการ)
                    if (entry.paymentType) {
                        detailsHTML += `
                            <div class="detail-item">
                                <strong>💼 ประเภทการจ่าย:</strong>
                                <span>${getPaymentTypeText(entry.paymentType)}</span>
                            </div>
                        `;
                    }

                    // แสดงหลายประเภทการจ่ายเงิน (สำหรับกรรมการรายการที่ 2+)
                    if (entry.multiplePaymentTypes && entry.multiplePaymentTypes.length > 0) {
                        detailsHTML += `
                            <div class="detail-item">
                                <strong>💼 ประเภทการจ่าย:</strong>
                                <div class="payment-types-list">
                        `;
                        entry.multiplePaymentTypes.forEach(payment => {
                            detailsHTML += `
                                <div class="payment-type-item">
                                    • ${getPaymentTypeText(payment.type)}
                                    ${payment.details ? `<br>&nbsp;&nbsp;<small>${payment.details}</small>` : ''}
                                </div>
                            `;
                        });
                        detailsHTML += `
                                </div>
                            </div>
                        `;
                    }

                    detailsHTML += `</div>`;
                });

                detailsHTML += `</div>`;
            }

            // แสดง modal
            showDetailModal(detailsHTML);
        }

        function getPaymentTypeText(type) {
            const types = {
                'salary': 'ค่าตอบแทน',
                'bonus': 'โบนัส',
                'allowance': 'เบี้ยเลี้ยง',
                'overtime': 'ค่าล่วงเวลา',
                'commission': 'ค่าคอมมิชชั่น',
                'facebook_ad': 'ค่าแอดเฟซบุค',
                'other': 'อื่นๆ'
            };
            return types[type] || type;
        }

        function formatDateTime(date) {
            const d = new Date(date);
            return d.toLocaleString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showDetailModal(content) {
            const modal = document.getElementById('detailModal');
            const modalBody = document.getElementById('detailModalBody');
            
            modalBody.innerHTML = content;
            modal.classList.add('show');
        }

        function closeDetailModal() {
            const modal = document.getElementById('detailModal');
            modal.classList.remove('show');
        }

        function addSubmittedUser(recipientName, submissionData = null) {
            // หาคนที่ชื่อตรงกับ recipientName ในรายชื่อพนักงาน
            let userName = recipientName;
            const foundEmployee = nameList.find(emp => 
                emp.name.includes(recipientName) || recipientName.includes(emp.name)
            );
            
            if (foundEmployee) {
                userName = foundEmployee.name;
            }
            
            // ตรวจสอบว่าคนนี้ส่งแล้วหรือยัง
            const alreadySubmitted = submittedUsers.some(user => user.name === userName);
            
            if (!alreadySubmitted) {
                const submissionRecord = {
                    name: userName,
                    recipientName: recipientName,
                    submittedAt: new Date(),
                    userType: document.getElementById('userType').value,
                    submissionData: submissionData // เก็บข้อมูลการส่งทั้งหมด
                };
                
                submittedUsers.push(submissionRecord);
                
                // บันทึกลง localStorage
                saveSubmittedUsers();
                
                // อัปเดต sidebar
                updateSidebar();
                
                console.log(`✅ เพิ่ม ${userName} ในรายการผู้ส่งสลิปแล้ว`);
            }
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInMs = now - date;
            const diffInMinutes = Math.floor(diffInMs / (1000 * 60));
            const diffInHours = Math.floor(diffInMs / (1000 * 60 * 60));
            const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
            
            if (diffInMinutes < 1) {
                return 'เมื่อสักครู่';
            } else if (diffInMinutes < 60) {
                return `${diffInMinutes} นาทีที่แล้ว`;
            } else if (diffInHours < 24) {
                return `${diffInHours} ชั่วโมงที่แล้ว`;
            } else {
                return `${diffInDays} วันที่แล้ว`;
            }
        }

        // ==================== LocalStorage for Submitted Users ====================
        function saveSubmittedUsers() {
            try {
                localStorage.setItem('submittedUsers', JSON.stringify(submittedUsers));
                console.log('✅ บันทึกรายการผู้ส่งสลิปสำเร็จ');
            } catch (error) {
                console.error('❌ ไม่สามารถบันทึกรายการผู้ส่งสลิปได้:', error);
            }
        }

        function loadSubmittedUsers() {
            try {
                const stored = localStorage.getItem('submittedUsers');
                if (stored) {
                    submittedUsers = JSON.parse(stored).map(user => ({
                        ...user,
                        submittedAt: new Date(user.submittedAt) // แปลง string เป็น Date object
                    }));
                    console.log(`📊 โหลดรายการผู้ส่งสลิป ${submittedUsers.length} คน`);
                }
            } catch (error) {
                console.warn('⚠️ ไม่สามารถโหลดรายการผู้ส่งสลิปได้:', error);
                submittedUsers = [];
            }
        }

        // ==================== OCR with Gemini Pro Vision ====================
        const GEMINI_API_KEY = 'AIzaSyDnijTt3my_sMB5y_IoVfOXxaV3gr0KOzY';
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro:generateContent';

        async function analyzePaymentSlipWithGemini(imageBase64, mimeType) {
            try {
                console.log('🔍 เริ่มวิเคราะห์สลิปด้วย Gemini Pro Vision...');
                
                const requestBody = {
                    contents: [{
                        parts: [
                            {
                                text: "วิเคราะห์สลิปการโอนเงินนี้ และให้ข้อมูลดังต่อไปนี้:\n1. ชื่อผู้รับเงิน (ชื่อบัญชีที่รับเงิน)\n2. จำนวนเงิน\n3. วันที่โอนเงิน\n4. ธนาคารที่รับเงิน\n\nตอบเป็นภาษาไทยและให้เฉพาะข้อมูลที่พบเท่านั้น หากไม่พบข้อมูลใดให้ระบุว่า 'ไม่พบข้อมูล'"
                            },
                            {
                                inline_data: {
                                    mime_type: mimeType,
                                    data: imageBase64
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0.1,
                        topK: 32,
                        topP: 1,
                        maxOutputTokens: 1024,
                    }
                };

                const response = await fetch(`${GEMINI_API_URL}?key=${GEMINI_API_KEY}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`Gemini API Error: ${response.status} - ${response.statusText}`);
                }

                const result = await response.json();
                console.log('✅ Gemini API Response:', result);
                
                if (result.candidates && result.candidates[0] && result.candidates[0].content) {
                    const analysisText = result.candidates[0].content.parts[0].text;
                    return parseGeminiResponse(analysisText);
                } else {
                    console.warn('⚠️ ไม่ได้รับผลลัพธ์จาก Gemini API');
                    return {
                        recipientName: 'ไม่พบข้อมูล',
                        amount: 'ไม่พบข้อมูล',
                        date: 'ไม่พบข้อมูล',
                        bank: 'ไม่พบข้อมูล'
                    };
                }
                
            } catch (error) {
                console.error('❌ เกิดข้อผิดพลาดในการวิเคราะห์สลิป:', error);
                return {
                    recipientName: 'เกิดข้อผิดพลาด',
                    amount: 'เกิดข้อผิดพลาด',
                    date: 'เกิดข้อผิดพลาด',
                    bank: 'เกิดข้อผิดพลาด',
                    error: error.message
                };
            }
        }

        function parseGeminiResponse(text) {
            console.log('📄 กำลังแยกข้อมูลจากการตอบของ Gemini:', text);
            
            const result = {
                recipientName: 'ไม่พบข้อมูล',
                amount: 'ไม่พบข้อมูล', 
                date: 'ไม่พบข้อมูล',
                bank: 'ไม่พบข้อมูล'
            };

            // แยกข้อมูลจากข้อความ
            const lines = text.split('\n');
            lines.forEach(line => {
                const lowerLine = line.toLowerCase().trim();
                
                // หาชื่อผู้รับเงิน
                if (lowerLine.includes('ผู้รับเงิน') || lowerLine.includes('ชื่อบัญชี') || lowerLine.includes('รับเงิน')) {
                    const match = line.match(/[:：]\s*(.+)/);
                    if (match && match[1].trim() && !match[1].includes('ไม่พบ')) {
                        result.recipientName = match[1].trim();
                    }
                }
                
                // หาจำนวนเงิน
                if (lowerLine.includes('จำนวนเงิน') || lowerLine.includes('จำนวน')) {
                    const match = line.match(/[:：]\s*(.+)/);
                    if (match && match[1].trim() && !match[1].includes('ไม่พบ')) {
                        result.amount = match[1].trim();
                    }
                }
                
                // หาวันที่
                if (lowerLine.includes('วันที่') || lowerLine.includes('วันที่โอน')) {
                    const match = line.match(/[:：]\s*(.+)/);
                    if (match && match[1].trim() && !match[1].includes('ไม่พบ')) {
                        result.date = match[1].trim();
                    }
                }
                
                // หาชื่อธนาคาร
                if (lowerLine.includes('ธนาคาร')) {
                    const match = line.match(/[:：]\s*(.+)/);
                    if (match && match[1].trim() && !match[1].includes('ไม่พบ')) {
                        result.bank = match[1].trim();
                    }
                }
            });
            
            console.log('✅ ข้อมูลที่แยกได้:', result);
            return result;
        }

        async function performOCROnFirstImage(entryIndex) {
            const fileInput = document.getElementById(`file${entryIndex}`);
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
                console.log('⚠️ ไม่พบไฟล์สำหรับการทำ OCR');
                return null;
            }

            const file = fileInput.files[0]; // ใช้ไฟล์แรกเท่านั้น
            
            // ตรวจสอบว่าเป็นไฟล์รูปภาพหรือไม่
            if (!file.type.startsWith('image/')) {
                console.log('⚠️ ไฟล์แรกไม่ใช่รูปภาพ ข้าม OCR');
                return null;
            }

            try {
                console.log(`🔍 เริ่มทำ OCR กับไฟล์: ${file.name}`);
                
                // แปลงไฟล์เป็น base64
                const base64Data = await fileToBase64(file);
                
                // เรียกใช้ Gemini Pro Vision
                const ocrResult = await analyzePaymentSlipWithGemini(base64Data, file.type);
                
                // แสดงผลลัพธ์ OCR
                displayOCRResult(entryIndex, ocrResult);
                
                return ocrResult;
                
            } catch (error) {
                console.error('❌ เกิดข้อผิดพลาดในการทำ OCR:', error);
                displayOCRError(entryIndex, error.message);
                return null;
            }
        }

        function displayOCRResult(entryIndex, result) {
            const ocrContainer = document.getElementById(`ocrContent${entryIndex}`);
            if (!ocrContainer) return;

            if (result && result.recipientName && result.recipientName !== 'ไม่พบข้อมูล' && result.recipientName !== 'เกิดข้อผิดพลาด') {
                ocrContainer.innerHTML = `
                    <div class="ocr-result success">
                        <h4>🎯 ข้อมูลจากสลิป</h4>
                        <div class="recipient-info">
                            <h4>👤 ${result.recipientName}</h4>
                            ${result.amount !== 'ไม่พบข้อมูล' ? `<p>💰 จำนวนเงิน: ${result.amount}</p>` : ''}
                            ${result.date !== 'ไม่พบข้อมูล' ? `<p>📅 วันที่: ${result.date}</p>` : ''}
                            ${result.bank !== 'ไม่พบข้อมูล' ? `<p>🏦 ธนาคาร: ${result.bank}</p>` : ''}
                        </div>
                    </div>
                `;
                console.log(`✅ แสดงผลลัพธ์ OCR สำเร็จ: ${result.recipientName}`);
            } else {
                ocrContainer.innerHTML = `
                    <div class="ocr-result error">
                        <h4>⚠️ ไม่สามารถอ่านข้อมูลจากสลิปได้</h4>
                        <p>กรุณาตรวจสอบคุณภาพของรูปภาพ</p>
                        ${result && result.error ? `<small>รายละเอียด: ${result.error}</small>` : ''}
                    </div>
                `;
                console.log('⚠️ ไม่สามารถอ่านข้อมูลจากสลิปได้');
            }
        }

        function displayOCRError(entryIndex, errorMessage) {
            const ocrContainer = document.getElementById(`ocrContent${entryIndex}`);
            if (!ocrContainer) return;

            ocrContainer.innerHTML = `
                <div class="ocr-result error">
                    <h4>❌ เกิดข้อผิดพลาดในการอ่านสลิป</h4>
                    <p>ไม่สามารถประมวลผลรูปภาพได้</p>
                    <small>รายละเอียด: ${errorMessage}</small>
                </div>
            `;
        }

        // ==================== เริ่มต้นระบบ ====================
        document.addEventListener('DOMContentLoaded', function() {
            // เริ่มต้น logo
            initializeLogo();
            
            // โหลดข้อมูลจาก LocalStorage
            loadNameListFromStorage();
            loadSubmittedUsers();
            
            // อัปเดต sidebar
            updateSidebar();
            
            // ตั้งค่า default user type เป็นพนักงานทั่วไป
            const userTypeSelect = document.getElementById('userType');
            userTypeSelect.value = 'employee';
            
            // เพิ่มรายการแรก
            addEntry();
            // แสดงรายชื่อ
            renderNameList();
            
            // เรียกใช้ handleUserTypeChange เพื่อตั้งค่า UI ตาม default
            handleUserTypeChange();
            
            // ตั้งค่า Form Submit
            document.getElementById('paymentForm').addEventListener('submit', handleFormSubmit);
            document.getElementById('nameForm').addEventListener('submit', handleNameSubmit);
            
            // ตั้งค่า User Type Change
            document.getElementById('userType').addEventListener('change', handleUserTypeChange);
        });

        // ==================== User Type Management ====================
        function handleUserTypeChange() {
            const userType = document.getElementById('userType').value;
            const addButton = document.querySelector('.btn-add');
            const entries = document.querySelectorAll('.entry-item');
            
            if (userType === 'employee') {
                // พนักงานทั่วไป: ซ่อนปุ่มเพิ่มรายการ และจำกัดให้มีได้แค่ 1 รายการ
                if (addButton) {
                    addButton.style.display = 'none';
                }
                
                // ลบรายการเกิน (เก็บแค่รายการแรก)
                if (entries.length > 1) {
                    for (let i = entries.length - 1; i > 0; i--) {
                        entries[i].remove();
                    }
                    updateEntryNumbers();
                }
                
                // อัปเดตรายละเอียดให้เป็นค่าตอบแทน
                updateEmployeePaymentDetails();
                
            } else if (userType === 'board_member') {
                // กรรมการบริษัท: แสดงปุ่มเพิ่มรายการ
                if (addButton) {
                    addButton.style.display = 'inline-flex';
                }
                
                // ล้างรายละเอียดที่อาจถูกตั้งค่าไว้อัตโนมัติ
                clearAutoGeneratedDetails();
                
                // ตั้งค่ารายการแรกเป็นค่าตอบแทน
                if (entries.length > 0) {
                    const firstEntry = entries[0];
                    const entryIndex = firstEntry.getAttribute('data-entry');
                    if (entryIndex) {
                        updateBoardMemberFirstEntryDetails(entryIndex);
                    }
                }
            }
            
            // อัปเดต UI ของการอัปโหลดไฟล์สำหรับรายการที่มีอยู่แล้ว
            entries.forEach(entry => {
                const entryIndex = entry.getAttribute('data-entry');
                if (entryIndex) {
                    updateFileUploadUI(entryIndex, userType);
                }
            });
        }
        
        function updateEmployeePaymentDetails() {
            const now = new Date();
            const currentMonth = now.getMonth(); // 0-11
            const currentYear = now.getFullYear();
            
            // คำนวณเดือนที่แล้ว
            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            
            // ชื่อเดือนภาษาไทย
            const thaiMonths = [
                'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
            ];
            
            // แปลงปี ค.ศ. เป็น พ.ศ.
            const lastMonthYearThai = lastMonthYear + 543;
            const currentYearThai = currentYear + 543;
            
            const paymentDetails = `ค่าตอบแทน (เดือน${thaiMonths[lastMonth]} ${lastMonthYearThai} ที่จ่ายในเดือน${thaiMonths[currentMonth]} ${currentYearThai})`;
            
            // อัปเดตรายละเอียดในรายการแรก
            const firstDetailsInput = document.querySelector('#entriesContainer .entry-item textarea');
            if (firstDetailsInput) {
                firstDetailsInput.value = paymentDetails;
                firstDetailsInput.readOnly = true;
                firstDetailsInput.style.backgroundColor = '#f8f9fa';
            }
        }
        
        function updateBoardMemberFirstEntryDetails(entryIndex) {
            // สำหรับกรรมการบริษัท รายการแรกจะเป็นค่าตอบแทนแบบคงที่
            const paymentDetails = 'ค่าตอบแทน (เดือนพฤษภาคม 2568 ที่จ่ายในเดือนมิถุนายน 2568)';
            
            // อัปเดตรายละเอียดในรายการที่ระบุ
            const detailsInput = document.getElementById(`details${entryIndex}`);
            if (detailsInput) {
                detailsInput.value = paymentDetails;
                detailsInput.readOnly = true;
                detailsInput.style.backgroundColor = '#f8f9fa';
            }
        }
        
        function clearAutoGeneratedDetails() {
            const allDetailsInputs = document.querySelectorAll('#entriesContainer .entry-item textarea');
            allDetailsInputs.forEach(input => {
                if (input.readOnly) {
                    input.value = '';
                    input.readOnly = false;
                    input.style.backgroundColor = '';
                }
            });
        }
        
        // ฟังก์ชันสำหรับอัปเดต UI ของการอัปโหลดไฟล์
        function updateFileUploadUI(entryIndex, userType) {
            const fileInput = document.getElementById(`file${entryIndex}`);
            const fileLabel = document.getElementById(`fileLabel${entryIndex}`);
            const fileText = document.getElementById(`fileText${entryIndex}`);
            const fileSmall = document.getElementById(`fileSmall${entryIndex}`);
            
            if (userType === 'employee') {
                // พนักงานทั่วไป: รองรับหลายไฟล์
                fileInput.setAttribute('multiple', 'multiple');
                fileLabel.textContent = '📄 อัปโหลดสลิป (สามารถเลือกหลายไฟล์พร้อมกัน)';
                fileText.textContent = 'คลิกหรือลากไฟล์มาที่นี่ (เลือกได้หลายไฟล์)';
                fileSmall.textContent = 'รองรับ JPG, PNG, PDF (ขนาดสูงสุด 10MB ต่อไฟล์)';
            } else {
                // กรรมการบริษัท: ไฟล์เดียว
                fileInput.removeAttribute('multiple');
                fileLabel.textContent = '📄 อัปโหลดสลิป';
                fileText.textContent = 'คลิกหรือลากไฟล์มาที่นี่';
                fileSmall.textContent = 'รองรับ JPG, PNG, PDF (ขนาดสูงสุด 10MB)';
            }
        }
        
        // ฟังก์ชันสำหรับอัปเดตรายละเอียดตามประเภทการจ่ายเงิน
        function updatePaymentDetails(entryIndex) {
            const paymentTypeSelect = document.getElementById(`paymentType${entryIndex}`);
            const detailsTextarea = document.getElementById(`details${entryIndex}`);
            const dateRangeSection = document.getElementById(`dateRangeSection${entryIndex}`);
            const paymentType = paymentTypeSelect.value;
            
            // ซ่อน/แสดงส่วนช่วงวันที่
            if (dateRangeSection) {
                if (paymentType === 'facebook_ad') {
                    dateRangeSection.style.display = 'block';
                } else {
                    dateRangeSection.style.display = 'none';
                }
            }
            
            if (!paymentType) {
                detailsTextarea.value = '';
                return;
            }
            
            const now = new Date();
            const currentMonth = now.getMonth(); // 0-11
            const currentYear = now.getFullYear();
            
            // คำนวณเดือนที่แล้ว
            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            
            // ชื่อเดือนภาษาไทย
            const thaiMonths = [
                'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
            ];
            
            // แปลงปี ค.ศ. เป็น พ.ศ.
            const lastMonthYearThai = lastMonthYear + 543;
            const currentYearThai = currentYear + 543;
            
            let paymentDetails = '';
            
            switch (paymentType) {
                case 'bp_rental':
                    paymentDetails = `ค่าเช่า BP จาก LL (เดือน${thaiMonths[lastMonth]} ${lastMonthYearThai} ที่จ่ายในเดือน${thaiMonths[currentMonth]} ${currentYearThai})`;
                    break;
                case 'position_fee':
                    paymentDetails = `ค่าตำแหน่ง (เดือน${thaiMonths[lastMonth]} ${lastMonthYearThai} ที่จ่ายในเดือน${thaiMonths[currentMonth]} ${currentYearThai})`;
                    break;
                case 'facebook_ad':
                    // สำหรับค่าแอดเฟซบุค ให้รอให้ผู้ใช้ใส่วันที่
                    paymentDetails = 'กรุณาระบุช่วงวันที่และกดปุ่ม "อัปเดตรายละเอียด"';
                    break;
                default:
                    paymentDetails = '';
            }
            
            detailsTextarea.value = paymentDetails;
        }
        
        // ฟังก์ชันสำหรับอัปเดตรายละเอียดค่าแอดเฟซบุค
        function updateFacebookAdDetails(entryIndex) {
            const startDay = document.getElementById(`startDay${entryIndex}`).value;
            const startMonth = document.getElementById(`startMonth${entryIndex}`).value;
            const endDay = document.getElementById(`endDay${entryIndex}`).value;
            const endMonth = document.getElementById(`endMonth${entryIndex}`).value;
            const detailsTextarea = document.getElementById(`details${entryIndex}`);
            
            if (!startDay || startMonth === '' || !endDay || endMonth === '') {
                showResult('กรุณาใส่วันที่และเดือนให้ครบถ้วน', 'error');
                return;
            }
            
            // ชื่อเดือนภาษาไทยแบบย่อ
            const thaiMonthsShort = [
                'ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.',
                'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'
            ];
            
            const paymentDetails = `ค่าแอดเฟซบุค ${startDay} ${thaiMonthsShort[parseInt(startMonth)]} - ${endDay} ${thaiMonthsShort[parseInt(endMonth)]}`;
            detailsTextarea.value = paymentDetails;
        }
        
        // ==================== Multiple Payment Types Management ====================
        let paymentTypeCount = 0;
        
        function addPaymentType(entryIndex) {
            const container = document.getElementById(`paymentTypesContainer${entryIndex}`);
            paymentTypeCount++;
            const paymentTypeId = `${entryIndex}_${paymentTypeCount}`;
            
            const paymentTypeHTML = `
                <div class="payment-type-item" id="paymentTypeItem_${paymentTypeId}" style="background: #f8f9ff; border: 2px solid #e6e8ff; border-radius: 10px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <h5 style="color: #667eea; margin: 0;">ประเภทการจ่ายเงิน #${paymentTypeCount}</h5>
                        <button type="button" class="btn btn-small" onclick="removePaymentType('${paymentTypeId}')" style="background: #ff6b6b;">
                            🗑️ ลบ
                        </button>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 15px;">
                        <select id="paymentType_${paymentTypeId}" onchange="updateMultiplePaymentDetails(${entryIndex}, '${paymentTypeId}')" required>
                            <option value="">-- เลือกประเภทการจ่ายเงิน --</option>
                            <option value="bp_rental">ค่าเช่า BP จาก LL</option>
                            <option value="position_fee">ค่าตำแหน่ง</option>
                            <option value="facebook_ad">ค่าแอดเฟซบุค</option>
                        </select>
                    </div>
                    
                    <div id="dateRangeSection_${paymentTypeId}" class="form-group" style="display:none;">
                        <label>📅 ช่วงวันที่ (สำหรับค่าแอดเฟซบุค)</label>
                        <div class="date-range-container">
                            <input type="number" id="startDay_${paymentTypeId}" placeholder="วันที่" min="1" max="31" style="width: 80px;">
                            <select id="startMonth_${paymentTypeId}" style="width: 120px;">
                                <option value="">เดือน</option>
                                <option value="0">ม.ค.</option>
                                <option value="1">ก.พ.</option>
                                <option value="2">มี.ค.</option>
                                <option value="3">เม.ย.</option>
                                <option value="4">พ.ค.</option>
                                <option value="5">มิ.ย.</option>
                                <option value="6">ก.ค.</option>
                                <option value="7">ส.ค.</option>
                                <option value="8">ก.ย.</option>
                                <option value="9">ต.ค.</option>
                                <option value="10">พ.ย.</option>
                                <option value="11">ธ.ค.</option>
                            </select>
                            <span class="date-range-separator">-</span>
                            <input type="number" id="endDay_${paymentTypeId}" placeholder="วันที่" min="1" max="31" style="width: 80px;">
                            <select id="endMonth_${paymentTypeId}" style="width: 120px;">
                                <option value="">เดือน</option>
                                <option value="0">ม.ค.</option>
                                <option value="1">ก.พ.</option>
                                <option value="2">มี.ค.</option>
                                <option value="3">เม.ย.</option>
                                <option value="4">พ.ค.</option>
                                <option value="5">มิ.ย.</option>
                                <option value="6">ก.ค.</option>
                                <option value="7">ส.ค.</option>
                                <option value="8">ก.ย.</option>
                                <option value="9">ต.ค.</option>
                                <option value="10">พ.ย.</option>
                                <option value="11">ธ.ค.</option>
                            </select>
                            <button type="button" onclick="updateMultipleFacebookAdDetails(${entryIndex}, '${paymentTypeId}')" class="btn btn-small" style="background: #28a745;">
                                อัปเดตรายละเอียด
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>📝 รายละเอียด</label>
                        <textarea id="paymentDetails_${paymentTypeId}" placeholder="รายละเอียดจะถูกสร้างอัตโนมัติเมื่อเลือกประเภทการจ่ายเงิน" readonly style="background-color: #f8f9fa;"></textarea>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', paymentTypeHTML);
        }
        
        function removePaymentType(paymentTypeId) {
            const item = document.getElementById(`paymentTypeItem_${paymentTypeId}`);
            if (item) {
                item.remove();
                // อัปเดตรายละเอียดรวม
                const entryIndex = paymentTypeId.split('_')[0];
                updateCombinedPaymentDetails(entryIndex);
            }
        }
        
        function updateMultiplePaymentDetails(entryIndex, paymentTypeId) {
            const paymentTypeSelect = document.getElementById(`paymentType_${paymentTypeId}`);
            const detailsTextarea = document.getElementById(`paymentDetails_${paymentTypeId}`);
            const dateRangeSection = document.getElementById(`dateRangeSection_${paymentTypeId}`);
            const paymentType = paymentTypeSelect.value;
            
            // ซ่อน/แสดงส่วนช่วงวันที่
            if (dateRangeSection) {
                if (paymentType === 'facebook_ad') {
                    dateRangeSection.style.display = 'block';
                } else {
                    dateRangeSection.style.display = 'none';
                }
            }
            
            if (!paymentType) {
                detailsTextarea.value = '';
                updateCombinedPaymentDetails(entryIndex);
                return;
            }
            
            const now = new Date();
            const currentMonth = now.getMonth(); // 0-11
            const currentYear = now.getFullYear();
            
            // คำนวณเดือนที่แล้ว
            const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
            const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
            
            // ชื่อเดือนภาษาไทย
            const thaiMonths = [
                'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
            ];
            
            // แปลงปี ค.ศ. เป็น พ.ศ.
            const lastMonthYearThai = lastMonthYear + 543;
            const currentYearThai = currentYear + 543;
            
            let paymentDetails = '';
            
            switch (paymentType) {
                case 'bp_rental':
                    paymentDetails = `ค่าเช่า BP จาก LL (เดือน${thaiMonths[lastMonth]} ${lastMonthYearThai} ที่จ่ายในเดือน${thaiMonths[currentMonth]} ${currentYearThai})`;
                    break;
                case 'position_fee':
                    paymentDetails = `ค่าตำแหน่ง (เดือน${thaiMonths[lastMonth]} ${lastMonthYearThai} ที่จ่ายในเดือน${thaiMonths[currentMonth]} ${currentYearThai})`;
                    break;
                case 'facebook_ad':
                    paymentDetails = 'กรุณาระบุช่วงวันที่และกดปุ่ม "อัปเดตรายละเอียด"';
                    break;
                default:
                    paymentDetails = '';
            }
            
            detailsTextarea.value = paymentDetails;
            updateCombinedPaymentDetails(entryIndex);
        }
        
        function updateMultipleFacebookAdDetails(entryIndex, paymentTypeId) {
            const startDay = document.getElementById(`startDay_${paymentTypeId}`).value;
            const startMonth = document.getElementById(`startMonth_${paymentTypeId}`).value;
            const endDay = document.getElementById(`endDay_${paymentTypeId}`).value;
            const endMonth = document.getElementById(`endMonth_${paymentTypeId}`).value;
            const detailsTextarea = document.getElementById(`paymentDetails_${paymentTypeId}`);
            
            if (!startDay || startMonth === '' || !endDay || endMonth === '') {
                showResult('กรุณาใส่วันที่และเดือนให้ครบถ้วน', 'error');
                return;
            }
            
            // ชื่อเดือนภาษาไทยแบบย่อ
            const thaiMonthsShort = [
                'ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.',
                'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'
            ];
            
            const paymentDetails = `ค่าแอดเฟซบุค ${startDay} ${thaiMonthsShort[parseInt(startMonth)]} - ${endDay} ${thaiMonthsShort[parseInt(endMonth)]}`;
            detailsTextarea.value = paymentDetails;
            updateCombinedPaymentDetails(entryIndex);
        }
        
        function updateCombinedPaymentDetails(entryIndex) {
            const container = document.getElementById(`paymentTypesContainer${entryIndex}`);
            const combinedDetailsTextarea = document.getElementById(`details${entryIndex}`);
            
            if (!container || !combinedDetailsTextarea) return;
            
            const paymentTypeItems = container.querySelectorAll('.payment-type-item');
            const details = [];
            
            paymentTypeItems.forEach(item => {
                const textarea = item.querySelector('textarea[id^="paymentDetails_"]');
                if (textarea && textarea.value.trim()) {
                    details.push(textarea.value.trim());
                }
            });
            
            combinedDetailsTextarea.value = details.join('\n');
        }

        // ==================== Tab Functions ====================
        function switchTab(tabId, buttonElement) {
            // ซ่อน tab ทั้งหมด
            const allTabs = document.querySelectorAll('.tab-content');
            allTabs.forEach(tab => tab.classList.remove('active'));
            
            // ซ่อนปุ่ม active ทั้งหมด
            const allButtons = document.querySelectorAll('.tab-btn');
            allButtons.forEach(btn => btn.classList.remove('active'));
            
            // แสดง tab ที่เลือก
            document.getElementById(tabId).classList.add('active');
            buttonElement.classList.add('active');
        }

        // ==================== Entry Management ====================
        function addEntry() {
            const userType = document.getElementById('userType').value;
            
            // ตรวจสอบว่าถ้าเป็นพนักงานทั่วไปและมีรายการอยู่แล้ว ห้ามเพิ่ม
            if (userType === 'employee') {
                const existingEntries = document.querySelectorAll('.entry-item');
                if (existingEntries.length >= 1) {
                    showResult('พนักงานทั่วไปสามารถอัปโหลดได้แค่ 1 รายการเท่านั้น', 'error');
                    return;
                }
            }
            
            const container = document.getElementById('entriesContainer');
            entryCount++;
            
            // ตรวจสอบว่าเป็นรายการที่เท่าไหร่ สำหรับกรรมการบริษัท
            const existingEntries = document.querySelectorAll('.entry-item');
            const isFirstEntry = existingEntries.length === 0;
            const isBoardMember = userType === 'board_member';
            
            // สร้าง HTML สำหรับรายละเอียด
            let detailsHTML = '';
            if (isBoardMember && !isFirstEntry) {
                // รายการที่ 2 เป็นต้นไปของกรรมการจะมีหลายประเภทการจ่ายเงินได้
                detailsHTML = `
                    <div class="form-group">
                        <label>📝 ประเภทการจ่ายเงิน</label>
                        <div id="paymentTypesContainer${entryCount}">
                            <!-- ประเภทการจ่ายเงินจะถูกเพิ่มที่นี่ -->
                        </div>
                        <button type="button" class="btn btn-small btn-add" onclick="addPaymentType(${entryCount})" style="margin-top: 10px;">
                            ➕ เพิ่มประเภทการจ่ายเงิน
                        </button>
                    </div>
                    <div class="form-group">
                        <label>📝 รายละเอียดรวม</label>
                        <textarea id="details${entryCount}" placeholder="รายละเอียดจะถูกสร้างอัตโนมัติจากประเภทการจ่ายเงินที่เลือก" required readonly></textarea>
                    </div>
                `;
            } else {
                // รายการแรกของกรรมการหรือรายการพนักงาน
                detailsHTML = `
                    <div class="form-group">
                        <label>📝 รายละเอียด</label>
                        <textarea id="details${entryCount}" placeholder="รายละเอียดการจ่ายเงิน เช่น ชื่อผู้รับ, จำนวนเงิน, วันที่, หมายเหตุ" required></textarea>
                    </div>
                `;
            }
            
            const entryHTML = `
                <div class="entry-item" data-entry="${entryCount}">
                    <div class="entry-header">
                        <h4>📋 รายการที่ ${entryCount}</h4>
                        <button type="button" class="btn-remove-entry" onclick="removeEntry(${entryCount})" ${entryCount === 1 ? 'style="display:none"' : ''}>
                            🗑️ ลบรายการ
                        </button>
                    </div>

                    <!-- อัปโหลดสลิป -->
                    <div class="form-group">
                        <label id="fileLabel${entryCount}">📄 อัปโหลดสลิป</label>
                        <div class="file-upload" id="fileUpload${entryCount}">
                            <input type="file" id="file${entryCount}" accept="image/*,.pdf" required>
                            <div class="file-upload-content">
                                <div class="file-upload-icon">📎</div>
                                <p id="fileText${entryCount}">คลิกหรือลากไฟล์มาที่นี่</p>
                                <small id="fileSmall${entryCount}">รองรับ JPG, PNG, PDF (ขนาดสูงสุด 10MB)</small>
                            </div>
                            <div class="file-info" style="display:none;"></div>
                        </div>
                    </div>

                    <!-- OCR Result Display -->
                    <div class="form-group">
                        <div id="ocrContent${entryCount}" class="ocr-container">
                            <!-- OCR results will be displayed here -->
                        </div>
                    </div>

                    ${detailsHTML}
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', entryHTML);
            
            // อัปเดต UI ตามประเภทผู้ใช้งาน
            updateFileUploadUI(entryCount, userType);
            
            setupFileUpload(entryCount);
            updateEntryNumbers();
            
            // ตั้งค่ารายละเอียดอัตโนมัติตามประเภทผู้ใช้งาน
            if (userType === 'employee') {
                updateEmployeePaymentDetails();
            } else if (userType === 'board_member' && existingEntries.length === 0) {
                // รายการแรกของกรรมการบริษัท
                updateBoardMemberFirstEntryDetails(entryCount);
            } else if (userType === 'board_member' && !isFirstEntry) {
                // รายการที่ 2 เป็นต้นไป: เพิ่มประเภทการจ่ายเงินแรก
                addPaymentType(entryCount);
            }
        }

        function removeEntry(entryIndex) {
            const userType = document.getElementById('userType').value;
            const entries = document.querySelectorAll('.entry-item');
            
            // ถ้าเป็นพนักงานทั่วไปและมีแค่รายการเดียว ห้ามลบ
            if (userType === 'employee' && entries.length <= 1) {
                showResult('พนักงานทั่วไปต้องมีรายการอย่างน้อย 1 รายการ', 'error');
                return;
            }
            
            const entryElement = document.querySelector(`[data-entry="${entryIndex}"]`);
            if (entryElement) {
                entryElement.remove();
                updateEntryNumbers();
            }
        }

        function updateEntryNumbers() {
            const entries = document.querySelectorAll('.entry-item');
            const userType = document.getElementById('userType').value;
            
            entries.forEach((entry, index) => {
                const header = entry.querySelector('.entry-header h4');
                header.textContent = `📋 รายการที่ ${index + 1}`;
                
                // แสดง/ซ่อนปุ่มลบ
                const removeBtn = entry.querySelector('.btn-remove-entry');
                if (userType === 'employee') {
                    // พนักงานทั่วไป: ซ่อนปุ่มลบเสมอ
                    removeBtn.style.display = 'none';
                } else if (entries.length > 1) {
                    // กรรมการบริษัท: แสดงปุ่มลบถ้ามีมากกว่า 1 รายการ
                    removeBtn.style.display = 'block';
                } else {
                    removeBtn.style.display = 'none';
                }
            });
        }

        function setupFileUpload(entryIndex) {
            const fileUpload = document.getElementById(`fileUpload${entryIndex}`);
            const fileInput = document.getElementById(`file${entryIndex}`);
            
            // ตั้งค่า drag & drop
            fileUpload.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });
            
            fileUpload.addEventListener('dragleave', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
            });
            
            fileUpload.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    handleFileSelect(files, entryIndex);
                }
            });
            
            // ตั้งค่า file input change
            fileInput.addEventListener('change', function(e) {
                if (this.files.length > 0) {
                    handleFileSelect(this.files, entryIndex);
                }
            });
        }

        function handleFileSelect(files, entryIndex) {
            const fileUpload = document.getElementById(`fileUpload${entryIndex}`);
            const fileInput = document.getElementById(`file${entryIndex}`);
            const fileInfo = fileUpload.querySelector('.file-info');
            
            // Convert FileList to Array
            const fileArray = Array.from(files);
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
            
            // ตรวจสอบไฟล์แต่ละไฟล์
            for (let file of fileArray) {
                // ตรวจสอบขนาดไฟล์ (10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showResult(`ไฟล์ "${file.name}" มีขนาดใหญ่เกิน 10MB กรุณาเลือกไฟล์ใหม่`, 'error');
                    return;
                }
                
                // ตรวจสอบประเภทไฟล์
                if (!allowedTypes.includes(file.type)) {
                    showResult(`ไฟล์ "${file.name}" ไม่ใช่ประเภทที่รองรับ กรุณาเลือกไฟล์ประเภท JPG, PNG หรือ PDF เท่านั้น`, 'error');
                    return;
                }
            }
            
            // อัปเดต UI
            fileUpload.classList.add('file-selected');
            fileInfo.style.display = 'block';
            
            if (fileArray.length === 1) {
                // แสดงไฟล์เดียว
                const file = fileArray[0];
                fileInfo.innerHTML = `
                    <strong>📎 ${file.name}</strong><br>
                    ขนาด: ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                    ประเภท: ${file.type}
                `;
            } else {
                // แสดงหลายไฟล์
                let totalSize = fileArray.reduce((sum, file) => sum + file.size, 0);
                let fileListHtml = fileArray.map(file => 
                    `<div class="file-item">
                        <strong>📎 ${file.name}</strong><br>
                        <small>ขนาด: ${(file.size / 1024 / 1024).toFixed(2)} MB | ประเภท: ${file.type}</small>
                    </div>`
                ).join('');
                
                fileInfo.innerHTML = `
                    <div class="files-summary">
                        📎 เลือกไฟล์แล้ว ${fileArray.length} ไฟล์<br>
                        <small>ขนาดรวม: ${(totalSize / 1024 / 1024).toFixed(2)} MB</small>
                    </div>
                    ${fileListHtml}
                `;
            }
            
            // อัปเดต file input (สำหรับ multiple files)
            const dt = new DataTransfer();
            fileArray.forEach(file => dt.items.add(file));
            fileInput.files = dt.files;
            
            // สร้าง image previews
            createImagePreviews(fileArray, entryIndex);
            
            // ปิดการทำ OCR ทันที - จะทำเฉพาะหลังส่งข้อมูลแล้วเท่านั้น
            // setTimeout(() => {
            //     performOCROnFirstImage(entryIndex);
            // }, 500);
        }

        // ==================== Form Submission ====================
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            // ตรวจสอบประเภทผู้ใช้งาน
            const userType = document.getElementById('userType').value;
            if (!userType) {
                showResult('กรุณาเลือกประเภทผู้ใช้งาน', 'error');
                return;
            }
            
            const entries = document.querySelectorAll('.entry-item');
            if (entries.length === 0) {
                showResult('กรุณาเพิ่มรายการอย่างน้อย 1 รายการ', 'error');
                return;
            }
            
            // ตรวจสอบข้อจำกัดตามประเภทผู้ใช้งาน
            if (userType === 'employee' && entries.length > 1) {
                showResult('พนักงานทั่วไปสามารถส่งได้แค่ 1 รายการเท่านั้น', 'error');
                return;
            }
            
            // ตรวจสอบข้อมูล
            let isValid = true;
            const entriesData = [];
            
            for (let i = 0; i < entries.length; i++) {
                const entry = entries[i];
                const entryIndex = entry.getAttribute('data-entry');
                const fileInput = document.getElementById(`file${entryIndex}`);
                const detailsInput = document.getElementById(`details${entryIndex}`);
                const paymentTypeSelect = document.getElementById(`paymentType${entryIndex}`);
                
                if (!fileInput.files || fileInput.files.length === 0) {
                    showResult(`กรุณาอัปโหลดไฟล์สำหรับรายการที่ ${i + 1}`, 'error');
                    isValid = false;
                    break;
                }
                
                // ตรวจสอบประเภทการจ่ายเงิน (สำหรับกรรมการบริษัทรายการที่ 2 เป็นต้นไป)
                if (paymentTypeSelect && !paymentTypeSelect.value.trim()) {
                    showResult(`กรุณาเลือกประเภทการจ่ายเงินสำหรับรายการที่ ${i + 1}`, 'error');
                    isValid = false;
                    break;
                }
                
                // ตรวจสอบหลายประเภทการจ่ายเงิน (สำหรับกรรมการบริษัทรายการที่ 2 เป็นต้นไป)
                const paymentTypesContainer = document.getElementById(`paymentTypesContainer${entryIndex}`);
                if (paymentTypesContainer) {
                    const paymentTypeItems = paymentTypesContainer.querySelectorAll('.payment-type-item');
                    if (paymentTypeItems.length === 0) {
                        showResult(`กรุณาเพิ่มประเภทการจ่ายเงินอย่างน้อย 1 ประเภทสำหรับรายการที่ ${i + 1}`, 'error');
                        isValid = false;
                        break;
                    }
                    
                    // ตรวจสอบแต่ละประเภทการจ่ายเงิน
                    for (let j = 0; j < paymentTypeItems.length; j++) {
                        const item = paymentTypeItems[j];
                        const paymentTypeId = item.id.replace('paymentTypeItem_', '');
                        const select = document.getElementById(`paymentType_${paymentTypeId}`);
                        const details = document.getElementById(`paymentDetails_${paymentTypeId}`);
                        
                        if (!select || !select.value.trim()) {
                            showResult(`กรุณาเลือกประเภทการจ่ายเงินให้ครบถ้วนในรายการที่ ${i + 1}`, 'error');
                            isValid = false;
                            break;
                        }
                        
                        // ตรวจสอบช่วงวันที่สำหรับค่าแอดเฟซบุค
                        if (select.value === 'facebook_ad') {
                            const startDay = document.getElementById(`startDay_${paymentTypeId}`);
                            const startMonth = document.getElementById(`startMonth_${paymentTypeId}`);
                            const endDay = document.getElementById(`endDay_${paymentTypeId}`);
                            const endMonth = document.getElementById(`endMonth_${paymentTypeId}`);
                            
                            if (!startDay || !startDay.value || 
                                !startMonth || startMonth.value === '' || 
                                !endDay || !endDay.value || 
                                !endMonth || endMonth.value === '') {
                                showResult(`กรุณาระบุช่วงวันที่ให้ครบถ้วนสำหรับประเภทการจ่าย "ค่าแอดเฟซบุค" ในรายการที่ ${i + 1}`, 'error');
                                isValid = false;
                                break;
                            }
                        }
                        
                        if (!details || !details.value.trim()) {
                            showResult(`กรุณาให้รายละเอียดการจ่ายเงินครบถ้วนในรายการที่ ${i + 1}`, 'error');
                            isValid = false;
                            break;
                        }
                    }
                    
                    if (!isValid) break;
                }
                
                // ตรวจสอบช่วงวันที่สำหรับค่าแอดเฟซบุค (แบบเดิม - สำหรับรายการที่ไม่มี multiple payment types)
                if (paymentTypeSelect && paymentTypeSelect.value === 'facebook_ad') {
                    const startDay = document.getElementById(`startDay${entryIndex}`);
                    const startMonth = document.getElementById(`startMonth${entryIndex}`);
                    const endDay = document.getElementById(`endDay${entryIndex}`);
                    const endMonth = document.getElementById(`endMonth${entryIndex}`);
                    
                    if (!startDay || !startDay.value || 
                        !startMonth || startMonth.value === '' || 
                        !endDay || !endDay.value || 
                        !endMonth || endMonth.value === '') {
                        showResult(`กรุณาระบุช่วงวันที่ให้ครบถ้วนสำหรับรายการที่ ${i + 1}`, 'error');
                        isValid = false;
                        break;
                    }
                }
                
                if (!detailsInput.value.trim()) {
                    showResult(`กรุณาใส่รายละเอียดสำหรับรายการที่ ${i + 1}`, 'error');
                    isValid = false;
                    break;
                }
                
                try {
                    // จัดการไฟล์หลายไฟล์
                    const files = Array.from(fileInput.files);
                    const slips = [];
                    
                    for (let file of files) {
                        const fileBase64 = await fileToBase64(file);
                        slips.push({
                            filename: file.name,
                            mimetype: file.type,
                            size: file.size,
                            data: fileBase64
                        });
                    }
                    
                    const entryData = {
                        entryNumber: i + 1,
                        slip: files.length === 1 ? slips[0] : slips, // ส่งเป็น object เดียวถ้ามีไฟล์เดียว, array ถ้ามีหลายไฟล์
                        slips: slips, // เก็บ array ไว้เสมอสำหรับการประมวลผล
                        fileCount: files.length,
                        details: detailsInput.value.trim()
                    };
                    
                    // เพิ่มข้อมูลหลายประเภทการจ่ายเงิน (สำหรับกรรมการบริษัทรายการที่ 2 เป็นต้นไป)
                    const paymentTypesContainer = document.getElementById(`paymentTypesContainer${entryIndex}`);
                    if (paymentTypesContainer) {
                        const paymentTypeItems = paymentTypesContainer.querySelectorAll('.payment-type-item');
                        const multiplePaymentTypes = [];
                        
                        paymentTypeItems.forEach(item => {
                            const paymentTypeId = item.id.replace('paymentTypeItem_', '');
                            const select = document.getElementById(`paymentType_${paymentTypeId}`);
                            const details = document.getElementById(`paymentDetails_${paymentTypeId}`);
                            
                            if (select && select.value && details && details.value.trim()) {
                                const paymentTypeData = {
                                    id: paymentTypeId,
                                    type: select.value,
                                    details: details.value.trim()
                                };
                                
                                // เพิ่มข้อมูลช่วงวันที่สำหรับค่าแอดเฟซบุค
                                if (select.value === 'facebook_ad') {
                                    const startDay = document.getElementById(`startDay_${paymentTypeId}`);
                                    const startMonth = document.getElementById(`startMonth_${paymentTypeId}`);
                                    const endDay = document.getElementById(`endDay_${paymentTypeId}`);
                                    const endMonth = document.getElementById(`endMonth_${paymentTypeId}`);
                                    
                                    paymentTypeData.dateRange = {
                                        startDay: startDay ? startDay.value : '',
                                        startMonth: startMonth ? startMonth.value : '',
                                        endDay: endDay ? endDay.value : '',
                                        endMonth: endMonth ? endMonth.value : ''
                                    };
                                }
                                
                                multiplePaymentTypes.push(paymentTypeData);
                            }
                        });
                        
                        entryData.multiplePaymentTypes = multiplePaymentTypes;
                        entryData.hasMultiplePaymentTypes = true;
                    }
                    
                    // เพิ่มประเภทการจ่ายเงิน (ถ้ามี - สำหรับแบบเดิม)
                    if (paymentTypeSelect) {
                        entryData.paymentType = paymentTypeSelect.value;
                        entryData.hasMultiplePaymentTypes = false;
                        
                        // เพิ่มข้อมูลช่วงวันที่สำหรับค่าแอดเฟซบุค
                        if (paymentTypeSelect.value === 'facebook_ad') {
                            const startDay = document.getElementById(`startDay${entryIndex}`);
                            const startMonth = document.getElementById(`startMonth${entryIndex}`);
                            const endDay = document.getElementById(`endDay${entryIndex}`);
                            const endMonth = document.getElementById(`endMonth${entryIndex}`);
                            
                            entryData.dateRange = {
                                startDay: startDay ? startDay.value : '',
                                startMonth: startMonth ? startMonth.value : '',
                                endDay: endDay ? endDay.value : '',
                                endMonth: endMonth ? endMonth.value : ''
                            };
                        }
                    }
                    
                    entriesData.push(entryData);
                } catch (error) {
                    showResult(`เกิดข้อผิดพลาดในการอ่านไฟล์รายการที่ ${i + 1}`, 'error');
                    isValid = false;
                    break;
                }
            }
            
            if (!isValid) return;
            
            // เตรียมข้อมูลส่ง
            const submitData = {
                userType: userType,
                entries: entriesData,
                nameList: nameList,
                submittedAt: new Date().toISOString(),
                formMode: "multiple-entries",
                totalEntries: entriesData.length
            };
            
            // แสดง loading
            showLoading(true);
            showProgress(0);
            
            try {
                // เพิ่มการ debug เพื่อตรวจสอบข้อมูล
                console.log('UserType:', userType);
                console.log('EntriesData:', entriesData);
                console.log('SubmitData:', submitData);
                
                // ตรวจสอบว่าเป็นพนักงานทั่วไปที่มีหลายไฟล์หรือไม่
                const isEmployee = userType === 'employee';
                const hasOneEntry = entriesData.length === 1;
                const hasMultipleFiles = entriesData[0] && entriesData[0].fileCount > 1;
                
                console.log('Is Employee:', isEmployee);
                console.log('Has One Entry:', hasOneEntry);
                console.log('Has Multiple Files:', hasMultipleFiles);
                
                const isEmployeeWithMultipleFiles = isEmployee && hasOneEntry && hasMultipleFiles;
                console.log('Process as Multiple Files:', isEmployeeWithMultipleFiles);
                
                if (isEmployeeWithMultipleFiles) {
                    // ส่งทีละไฟล์สำหรับพนักงานทั่วไป
                    console.log('🔄 เริ่มประมวลผลแบบหลายไฟล์');
                    await processEmployeeMultipleFiles(submitData, entriesData[0]);
                } else {
                    // ส่งแบบปกติสำหรับกรรมการหรือพนักงานที่มีไฟล์เดียว
                    console.log('🔄 เริ่มประมวลผลแบบปกติ');
                    await processSingleSubmission(submitData);
                }
                
            } catch (error) {
                console.error('Error:', error);
                showLoading(false);
                
                // แสดงข้อความแก้ไขที่มีรายละเอียดมากขึ้น
                let errorMessage = '❌ เกิดข้อผิดพลาดในการส่งข้อมูล';
                if (error.message.includes('Failed to fetch')) {
                    errorMessage += ' - ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้';
                } else if (error.message.includes('HTTP Error')) {
                    errorMessage += ` - ${error.message}`;
                }
                errorMessage += ' กรุณาลองใหม่อีกครั้ง';
                
                showResult(errorMessage, 'error');
            }
        }

        // ฟังก์ชันสำหรับประมวลผล OCR เบื้องหลัง
        async function processOCRInBackground(ocrData) {
            console.log('🔍 เริ่มประมวลผล OCR เบื้องหลัง...');
            
            try {
                const firstEntry = ocrData.entries[0];
                if (!firstEntry || !firstEntry.slips || firstEntry.slips.length === 0) {
                    console.log('⚠️ ไม่พบไฟล์สำหรับ OCR');
                    return;
                }
                
                // ตรวจสอบว่าเป็นพนักงานทั่วไปหรือไม่
                const isEmployee = ocrData.userType === 'employee';
                
                if (isEmployee) {
                    // สำหรับพนักงานทั่วไป: ประมวลผลทุกไฟล์รูปภาพ
                    await processAllImageFilesOCR(firstEntry, ocrData);
                } else {
                    // สำหรับกรรมการ: ประมวลผลไฟล์แรกเท่านั้น
                    await processSingleImageOCR(firstEntry, ocrData);
                }
                
            } catch (error) {
                console.error('❌ เกิดข้อผิดพลาดใน OCR เบื้องหลัง:', error);
            }
        }

        // ฟังก์ชันสำหรับประมวลผลไฟล์เดียว (กรรมการ)
        async function processSingleImageOCR(entry, ocrData) {
            // หาไฟล์รูปภาพแรก
            const imageFile = entry.slips.find(slip => slip.mimetype && slip.mimetype.startsWith('image/'));
            if (!imageFile) {
                console.log('⚠️ ไม่พบไฟล์รูปภาพสำหรับ OCR');
                return;
            }
            
            console.log(`🖼️ กำลังประมวลผลไฟล์: ${imageFile.filename}`);
            
            // เรียกใช้ Gemini OCR
            const ocrResult = await analyzePaymentSlipWithGemini(imageFile.data, imageFile.mimetype);
            
            // ถ้า OCR สำเร็จและพบชื่อผู้รับเงิน
            if (ocrResult && ocrResult.recipientName && 
                ocrResult.recipientName !== 'ไม่พบข้อมูล' && 
                ocrResult.recipientName !== 'เกิดข้อผิดพลาด') {
                
                console.log(`✅ OCR สำเร็จ: พบชื่อผู้รับเงิน - ${ocrResult.recipientName}`);
                
                // เพิ่มไปยัง sidebar พร้อมข้อมูลการส่ง
                addSubmittedUser(ocrResult.recipientName, {
                    ocrResult: ocrResult,
                    entries: ocrData.entries,
                    userType: ocrData.userType,
                    processedAt: new Date(),
                    processedFiles: [imageFile.filename]
                });
                
                // แสดงผลลัพธ์ OCR ใน console
                console.log('📋 ข้อมูลที่อ่านได้:', {
                    ชื่อผู้รับเงิน: ocrResult.recipientName,
                    จำนวนเงิน: ocrResult.amount,
                    วันที่: ocrResult.date,
                    ธนาคาร: ocrResult.bank
                });
            } else {
                console.log('⚠️ OCR ไม่สามารถอ่านชื่อผู้รับเงินได้');
            }
        }

        // ฟังก์ชันสำหรับประมวลผลทุกไฟล์ (พนักงานทั่วไป)
        async function processAllImageFilesOCR(entry, ocrData) {
            // หาไฟล์รูปภาพทั้งหมด
            const imageFiles = entry.slips.filter(slip => slip.mimetype && slip.mimetype.startsWith('image/'));
            if (imageFiles.length === 0) {
                console.log('⚠️ ไม่พบไฟล์รูปภาพสำหรับ OCR');
                return;
            }
            
            console.log(`🖼️ กำลังประมวลผล ${imageFiles.length} ไฟล์รูปภาพ...`);
            
            const allOCRResults = [];
            const processedFileNames = [];
            
            // ประมวลผลทีละไฟล์
            for (let i = 0; i < imageFiles.length; i++) {
                const imageFile = imageFiles[i];
                console.log(`📄 ประมวลผลไฟล์ที่ ${i + 1}/${imageFiles.length}: ${imageFile.filename}`);
                
                try {
                    // เรียกใช้ Gemini OCR
                    const ocrResult = await analyzePaymentSlipWithGemini(imageFile.data, imageFile.mimetype);
                    
                    if (ocrResult && ocrResult.recipientName && 
                        ocrResult.recipientName !== 'ไม่พบข้อมูล' && 
                        ocrResult.recipientName !== 'เกิดข้อผิดพลาด') {
                        
                        allOCRResults.push({
                            ...ocrResult,
                            filename: imageFile.filename,
                            fileIndex: i + 1
                        });
                        processedFileNames.push(imageFile.filename);
                        
                        console.log(`✅ OCR ไฟล์ ${i + 1} สำเร็จ: ${ocrResult.recipientName}`);
                    } else {
                        console.log(`⚠️ OCR ไฟล์ ${i + 1} ไม่พบข้อมูล: ${imageFile.filename}`);
                    }
                    
                    // รอสักครู่ระหว่างการประมวลผล
                    if (i < imageFiles.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                    
                } catch (error) {
                    console.error(`❌ เกิดข้อผิดพลาดใน OCR ไฟล์ ${i + 1}:`, error);
                }
            }
            
            // แสดงผลลัพธ์รวม
            if (allOCRResults.length > 0) {
                console.log(`📊 สรุปผลลัพธ์ OCR: พบข้อมูล ${allOCRResults.length}/${imageFiles.length} ไฟล์`);
                
                // เพิ่มรายการสำหรับแต่ละผู้รับเงินที่พบ
                const uniqueRecipients = [];
                
                allOCRResults.forEach(result => {
                    // ตรวจสอบว่ามีชื่อผู้รับเงินนี้แล้วหรือยัง
                    const existingRecipient = uniqueRecipients.find(r => 
                        r.recipientName.toLowerCase().includes(result.recipientName.toLowerCase()) ||
                        result.recipientName.toLowerCase().includes(r.recipientName.toLowerCase())
                    );
                    
                    if (!existingRecipient) {
                        uniqueRecipients.push(result);
                    }
                });
                
                // เพิ่มแต่ละผู้รับเงินที่ไม่ซ้ำกันไปยัง sidebar
                uniqueRecipients.forEach((result, index) => {
                    setTimeout(() => {
                        addSubmittedUser(result.recipientName, {
                            ocrResult: result,
                            entries: ocrData.entries,
                            userType: ocrData.userType,
                            processedAt: new Date(),
                            processedFiles: processedFileNames,
                            allOCRResults: allOCRResults,
                            isMultipleFiles: true
                        });
                        
                        console.log(`👤 เพิ่มผู้รับเงิน: ${result.recipientName} (จากไฟล์ ${result.filename})`);
                    }, index * 500); // เพิ่มทีละคนทุก 0.5 วินาที
                });
                
                // แสดงสรุปใน console
                console.log('📋 สรุปข้อมูลที่อ่านได้ทั้งหมด:', allOCRResults.map(r => ({
                    ไฟล์: r.filename,
                    ชื่อผู้รับเงิน: r.recipientName,
                    จำนวนเงิน: r.amount,
                    วันที่: r.date,
                    ธนาคาร: r.bank
                })));
                
            } else {
                console.log('⚠️ ไม่สามารถอ่านข้อมูลจากไฟล์รูปภาพใดๆ ได้');
            }
        }

        // ฟังก์ชันสำหรับรีเซ็ตข้อมูลผู้ส่งสลิป
        function resetSubmittedUsers() {
            if (confirm('คุณต้องการล้างข้อมูลผู้ส่งสลิปทั้งหมดหรือไม่?')) {
                submittedUsers = [];
                saveSubmittedUsers();
                updateSidebar();
                showResult('🗑️ ล้างข้อมูลผู้ส่งสลิปเรียบร้อยแล้ว', 'success');
                console.log('🗑️ รีเซ็ตข้อมูลผู้ส่งสลิปแล้ว');
            }
        }

        // ฟังก์ชันสำหรับส่งข้อมูลแบบปกติ
        async function processSingleSubmission(submitData) {
            // อัปเดต progress
            showProgress(25);
            
            // แสดงข้อมูลใน console สำหรับการ debug
            console.log('ข้อมูลที่จะส่ง:', submitData);
            
            const response = await fetch('http://localhost:5678/webhook/payment-process', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(submitData)
            });
            
            showProgress(75);
            
            if (response.ok) {
                const result = await response.json();
                showProgress(100);
                
                setTimeout(() => {
                    showLoading(false);
                    showResult('✅ ส่งข้อมูลสำเร็จ! ระบบได้รับข้อมูลการจ่ายเงินแล้ว', 'success');
                    
                    // ทำ OCR และอัปเดต sidebar เบื้องหลัง
                    const ocrProcessingData = {
                        entries: submitData.entries,
                        userType: submitData.userType
                    };
                    processOCRInBackground(ocrProcessingData);
                    
                    resetAllEntries();
                }, 500);
            } else {
                throw new Error(`HTTP Error: ${response.status} - ${response.statusText}`);
            }
        }
        
        // ฟังก์ชันสำหรับส่งหลายไฟล์ทีละไฟล์ (พนักงานทั่วไป)
        async function processEmployeeMultipleFiles(baseSubmitData, entryData) {
            const files = entryData.slips;
            const totalFiles = files.length;
            let successCount = 0;
            let failedFiles = [];
            
            const estimatedTime = (totalFiles - 1) * 30; // เวลาที่ใช้ในการหน่วง (วินาที)
            const estimatedMinutes = Math.ceil(estimatedTime / 60);
            
            console.log(`🔄 เริ่มส่งข้อมูล ${totalFiles} ไฟล์ทีละไฟล์ (หน่วงเวลา 30 วินาทีระหว่างไฟล์)`);
            console.log(`⏱️ เวลาโดยประมาณ: ${estimatedTime} วินาที (${estimatedMinutes} นาที)`);
            
            for (let i = 0; i < totalFiles; i++) {
                const currentFile = files[i];
                const fileNumber = i + 1;
                
                try {
                    // คำนวณ progress สำหรับไฟล์ปัจจุบัน
                    const baseProgress = 25;
                    const progressPerFile = 70 / totalFiles; // 70% สำหรับการส่งไฟล์ทั้งหมด
                    const currentProgress = baseProgress + (progressPerFile * i);
                    
                    showProgress(currentProgress);
                    
                    // สร้างข้อมูลสำหรับไฟล์เดียว
                    const singleFileData = {
                        ...baseSubmitData,
                        entries: [{
                            entryNumber: 1,
                            slip: currentFile,
                            slips: [currentFile],
                            fileCount: 1,
                            fileNumber: fileNumber, // เพิ่มหมายเลขไฟล์
                            totalFiles: totalFiles, // เพิ่มจำนวนไฟล์ทั้งหมด
                            details: entryData.details
                        }],
                        totalEntries: 1,
                        currentFileIndex: i,
                        isMultiFileProcess: true
                    };
                    
                    console.log(`📄 ส่งไฟล์ที่ ${fileNumber}/${totalFiles}: ${currentFile.filename}`);
                    
                    // อัปเดตข้อความ loading
                    const loadingSection = document.getElementById('loadingSection');
                    const loadingText = loadingSection.querySelector('p');
                    if (loadingText) {
                        loadingText.innerHTML = `กำลังประมวลผลข้อมูล...<br><small>ไฟล์ที่ ${fileNumber}/${totalFiles}: ${currentFile.filename}</small>`;
                    }
                    
                    console.log(`📤 ส่งไฟล์ที่ ${fileNumber}/${totalFiles}:`, singleFileData);
                    
                    const response = await fetch('http://localhost:5678/webhook/payment-process', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(singleFileData)
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        successCount++;
                        console.log(`✅ ไฟล์ที่ ${fileNumber} ส่งสำเร็จ:`, result);
                    } else {
                        throw new Error(`HTTP Error: ${response.status} - ${response.statusText}`);
                    }
                    
                    // รอสักครู่ระหว่างการส่งแต่ละไฟล์ (30 วินาที)
                    if (i < totalFiles - 1) {
                        console.log(`⏳ รอ 30 วินาทีก่อนส่งไฟล์ถัดไป...`);
                        
                        // แสดงการนับถอยหลัง
                        for (let countdown = 30; countdown > 0; countdown--) {
                            const loadingText = loadingSection.querySelector('p');
                            if (loadingText) {
                                loadingText.innerHTML = `กำลังประมวลผลข้อมูล...<br><small>ไฟล์ที่ ${fileNumber}/${totalFiles} ส่งสำเร็จ</small><br><strong>⏰ รอ ${countdown} วินาที ก่อนส่งไฟล์ถัดไป</strong>`;
                            }
                            
                            // อัปเดต progress bar ในระหว่างรอ
                            const waitProgress = currentProgress + (progressPerFile * (30 - countdown) / 30 * 0.5);
                            showProgress(waitProgress);
                            
                            await new Promise(resolve => setTimeout(resolve, 1000));
                        }
                        
                        console.log(`🚀 เริ่มส่งไฟล์ถัดไป...`);
                    }
                    
                } catch (error) {
                    console.error(`❌ ไฟล์ที่ ${fileNumber} ส่งไม่สำเร็จ:`, error);
                    failedFiles.push({
                        fileNumber: fileNumber,
                        filename: currentFile.filename,
                        error: error.message
                    });
                }
            }
            
            // แสดงผลลัพธ์
            showProgress(100);
            
            setTimeout(() => {
                showLoading(false);
                
                if (successCount === totalFiles) {
                    showResult(`✅ ส่งข้อมูลสำเร็จทั้งหมด! ประมวลผล ${totalFiles} ไฟล์เรียบร้อย`, 'success');
                    
                    // ทำ OCR และอัปเดต sidebar เบื้องหลัง
                    const ocrProcessingData = {
                        entries: [entryData],
                        userType: baseSubmitData.userType
                    };
                    processOCRInBackground(ocrProcessingData);
                    
                    resetAllEntries();
                } else if (successCount > 0) {
                    const failedList = failedFiles.map(f => f.filename).join(', ');
                    showResult(`⚠️ ส่งสำเร็จ ${successCount}/${totalFiles} ไฟล์ | ไฟล์ที่ล้มเหลว: ${failedList}`, 'error');
                } else {
                    showResult(`❌ ส่งข้อมูลล้มเหลวทั้งหมด! กรุณาลองใหม่อีกครั้ง`, 'error');
                }
            }, 500);
        }

        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function resetAllEntries() {
            const container = document.getElementById('entriesContainer');
            container.innerHTML = '';
            entryCount = 0;
            addEntry();
            
            // รีเซ็ตสถานะปุ่มตามประเภทผู้ใช้งาน
            handleUserTypeChange();
        }

        // ==================== Name Management ====================
        function renderNameList() {
            const container = document.getElementById('namesList');
            container.innerHTML = '';
            
            nameList.forEach((person, index) => {
                const nameHTML = `
                    <div class="name-item">
                        <h4>👤 ${person.name}</h4>
                        ${person.position ? `<p>💼 ${person.position}</p>` : ''}
                        ${person.department ? `<p>🏢 ${person.department}</p>` : ''}
                        ${person.notes ? `<p>📝 ${person.notes}</p>` : ''}
                        <div class="name-actions">
                            <button class="btn btn-small btn-edit" onclick="editName(${index})">
                                ✏️ แก้ไข
                            </button>
                            <button class="btn btn-small btn-delete" onclick="deleteName(${index})">
                                🗑️ ลบ
                            </button>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', nameHTML);
            });
        }

        function openAddModal() {
            editingIndex = -1;
            document.getElementById('modalTitle').textContent = '📁เพิ่มรายชื่อใหม่';
            document.getElementById('nameForm').reset();
            document.getElementById('nameModal').classList.add('show');
        }

        function editName(index) {
            editingIndex = index;
            const person = nameList[index];
            
            document.getElementById('modalTitle').textContent = '✏️ แก้ไขรายชื่อ';
            document.getElementById('nameInput').value = person.name;
            document.getElementById('positionInput').value = person.position || '';
            document.getElementById('departmentInput').value = person.department || '';
            document.getElementById('notesInput').value = person.notes || '';
            
            document.getElementById('nameModal').classList.add('show');
        }

        function deleteName(index) {
            if (confirm('ต้องการลบรายชื่อนี้หรือไม่?')) {
                nameList.splice(index, 1);
                
                // บันทึกลง LocalStorage
                saveNameListToStorage();
                
                renderNameList();
                showResult('ลบรายชื่อเรียบร้อยแล้ว', 'success');
            }
        }

        function closeModal() {
            document.getElementById('nameModal').classList.remove('show');
            editingIndex = -1;
        }

        function handleNameSubmit(e) {
            e.preventDefault();
            
            const name = document.getElementById('nameInput').value.trim();
            const position = document.getElementById('positionInput').value.trim();
            const department = document.getElementById('departmentInput').value.trim();
            const notes = document.getElementById('notesInput').value.trim();
            
            if (!name) {
                showResult('กรุณาใส่ชื่อ-นามสกุล', 'error');
                return;
            }
            
            const personData = { name, position, department, notes };
            
            if (editingIndex >= 0) {
                nameList[editingIndex] = personData;
                showResult('แก้ไขรายชื่อเรียบร้อยแล้ว', 'success');
            } else {
                nameList.push(personData);
                showResult('เพิ่มรายชื่อเรียบร้อยแล้ว', 'success');
            }
            
            // บันทึกลง LocalStorage
            saveNameListToStorage();
            
            renderNameList();
            closeModal();
        }

        // ==================== UI Helper Functions ====================
        function showLoading(show) {
            const loading = document.getElementById('loadingSection');
            if (show) {
                loading.classList.add('show');
            } else {
                loading.classList.remove('show');
                hideProgress();
            }
        }

        function showProgress(percent) {
            const container = document.getElementById('progressContainer');
            const bar = document.getElementById('progressBar');
            
            container.classList.add('show');
            bar.style.width = percent + '%';
        }

        function hideProgress() {
            const container = document.getElementById('progressContainer');
            container.classList.remove('show');
        }

        function showResult(message, type) {
            const resultDiv = document.getElementById('resultMessage');
            resultDiv.textContent = message;
            resultDiv.className = `result-message ${type} show`;
            
            // ซ่อนข้อความหลัง 5 วินาที
            setTimeout(() => {
                resultDiv.classList.remove('show');
            }, 5000);
        }

        // ==================== Image Preview Functions ====================
        function createImagePreviews(files, entryIndex) {
            const fileUpload = document.getElementById(`fileUpload${entryIndex}`);
            let previewContainer = fileUpload.querySelector('.file-preview-container');
            
            // ลบ preview container เก่า (ถ้ามี)
            if (previewContainer) {
                previewContainer.remove();
            }
            
            // สร้าง preview container ใหม่
            previewContainer = document.createElement('div');
            previewContainer.className = 'file-preview-container';
            
            const fileArray = Array.from(files);
            fileArray.forEach((file, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'file-preview-item';
                previewItem.setAttribute('data-file-index', index);
                previewItem.setAttribute('data-entry-index', entryIndex);
                
                if (file.type.startsWith('image/')) {
                    // สำหรับรูปภาพ
                    const img = document.createElement('img');
                    img.className = 'file-preview-image';
                    img.alt = file.name;
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        img.src = e.target.result;
                        img.setAttribute('data-full-src', e.target.result);
                        img.setAttribute('data-file-name', file.name);
                        img.setAttribute('data-file-size', file.size);
                        img.setAttribute('data-file-type', file.type);
                    };
                    reader.readAsDataURL(file);
                    
                    previewItem.appendChild(img);
                } else if (file.type === 'application/pdf') {
                    // สำหรับ PDF
                    const pdfDiv = document.createElement('div');
                    pdfDiv.className = 'file-preview-pdf';
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        pdfDiv.setAttribute('data-pdf-src', e.target.result);
                        pdfDiv.setAttribute('data-file-name', file.name);
                        pdfDiv.setAttribute('data-file-size', file.size);
                        pdfDiv.setAttribute('data-file-type', file.type);
                    };
                    reader.readAsDataURL(file);
                    
                    pdfDiv.innerHTML = `
                        <div class="file-preview-pdf-icon">📄</div>
                        <div>PDF</div>
                    `;
                    
                    previewItem.appendChild(pdfDiv);
                }
                
                // เพิ่ม overlay ข้อมูลไฟล์
                const overlay = document.createElement('div');
                overlay.className = 'file-preview-overlay';
                overlay.textContent = file.name.length > 35 ? 
                    file.name.substring(0, 35) + '...' : file.name;
                previewItem.appendChild(overlay);
                
                // เพิ่ม click event เพื่อเปิด modal
                previewItem.addEventListener('click', function() {
                    openImageModal(this);
                });
                
                previewContainer.appendChild(previewItem);
            });
            
            fileUpload.appendChild(previewContainer);
        }
        
        function openImageModal(previewItem) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const modalPdf = document.getElementById('modalPdf');
            const modalInfo = document.getElementById('modalInfo');
            
            // ซ่อนทั้งคู่ก่อน
            modalImage.style.display = 'none';
            modalPdf.style.display = 'none';
            
            const img = previewItem.querySelector('.file-preview-image');
            const pdf = previewItem.querySelector('.file-preview-pdf');
            
            if (img) {
                // แสดงรูปภาพ
                modalImage.src = img.getAttribute('data-full-src');
                modalImage.style.display = 'block';
                
                const fileName = img.getAttribute('data-file-name');
                const fileSize = img.getAttribute('data-file-size');
                const fileType = img.getAttribute('data-file-type');
                
                modalInfo.innerHTML = `
                    <strong>${fileName}</strong><br>
                    ขนาด: ${(fileSize / 1024 / 1024).toFixed(2)} MB | 
                    ประเภท: ${fileType}
                `;
            } else if (pdf) {
                // แสดง PDF
                modalPdf.src = pdf.getAttribute('data-pdf-src');
                modalPdf.style.display = 'block';
                
                const fileName = pdf.getAttribute('data-file-name');
                const fileSize = pdf.getAttribute('data-file-size');
                const fileType = pdf.getAttribute('data-file-type');
                
                modalInfo.innerHTML = `
                    <strong>${fileName}</strong><br>
                    ขนาด: ${(fileSize / 1024 / 1024).toFixed(2)} MB | 
                    ประเภท: ${fileType}
                `;
            }
            
            modal.classList.add('show');
            
            // เพิ่ม event listener สำหรับคลิกพื้นหลังเพื่อปิด modal
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeImageModal();
                }
            };
        }
        
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('show');
            
            // ล้าง src เพื่อประหยัดหน่วยความจำ
            const modalImage = document.getElementById('modalImage');
            const modalPdf = document.getElementById('modalPdf');
            modalImage.src = '';
            modalPdf.src = '';
            
            // ลบ event listener
            modal.onclick = null;
        }

        // ==================== Keyboard Shortcuts ====================
        document.addEventListener('keydown', function(e) {
            // Escape เพื่อปิด modal
            if (e.key === 'Escape') {
                // ปิด image modal ก่อน (ถ้าเปิดอยู่)
                const imageModal = document.getElementById('imageModal');
                if (imageModal.classList.contains('show')) {
                    closeImageModal();
                } else {
                    closeModal();
                }
            }
            
            // Ctrl+Enter เพื่อส่งฟอร์ม (เฉพาะเมื่ออยู่ใน upload tab)
            if (e.ctrlKey && e.key === 'Enter') {
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab && activeTab.id === 'upload-tab') {
                    document.getElementById('paymentForm').dispatchEvent(new Event('submit'));
                }
            }
        });

        // ==================== Click Outside Modal ====================
        document.getElementById('nameModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });
    </script>
</body>
</html>